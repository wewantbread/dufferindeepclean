<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exported</title>
  <link rel="stylesheet" href="style.css"/>
</head>


  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&family=Great+Vibes&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="nav-cart.js" defer></script>

  <style>
    :root{
      --bg-tile: url('backgroundbook.png');
      --tile-w: 1536px;
      --tile-h: 1024px;
      --tile-scale: 0.90;
      --tile-w-size: calc(var(--tile-w) * var(--tile-scale));
      --tile-h-size: calc(var(--tile-h) * var(--tile-scale));
      --overlay-a: rgba(0,0,0,0.52);
      --overlay-b: rgba(0,0,0,0.78);
      --overlay-c: rgba(0,0,0,0.90);
    }

    html, body {
      min-height: 100%;
      background:#000;
      overflow-y: auto;
    }
    body {
      color: #f2f5f8;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: transparent !important;
    }

    body::after{
      content:"";
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background-image: var(--bg-tile);
      background-repeat: repeat;
      background-size: var(--tile-w-size) var(--tile-h-size);
      background-position: 0 0;
      animation: bgInfinite 56s linear infinite;
    }
    @keyframes bgInfinite {
      from { background-position: 0 0; }
      to   { background-position: var(--tile-w-size) var(--tile-h-size); }
    }

    body::before{
      content:"";
      position: fixed; inset: 0; z-index: 1; pointer-events: none;
      background: radial-gradient(1200px 600px at 50% -10%, var(--overlay-a), var(--overlay-b) 60%, var(--overlay-c));
    }

    .navbar, main, section, footer { position: relative; z-index: 2; }

    .navbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: clamp(1rem, 2vw, 2.4rem);
      padding: 14px 22px;
      background: rgba(0,0,0,0.20);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      position: sticky; top: 0; z-index: 1000;
    }
    .logo{ display:flex; align-items:center; gap:.55rem; }
    .logo .soap{ font-size: 2.2rem; transform: translateY(2px); }
    .logo .logo-text{
      font-family: 'Great Vibes', cursive !important;
      font-size: 2.8rem; line-height: 1; letter-spacing: .4px; color:#fff;
      position:relative; display:inline-block;
      clip-path: inset(0 100% 0 0); opacity:0;
      animation: logoUnveil 1.1s ease forwards .25s;
      text-decoration: none;
    }
    @keyframes logoUnveil{0%{clip-path:inset(0 100% 0 0);opacity:0}40%{opacity:1}100%{clip-path:inset(0 0 0 0);opacity:1}}
    @keyframes logoSweep{0%{opacity:1;transform:translateX(-105%)}60%{opacity:.75}100%{opacity:0;transform:translateX(120%)}}
    .logo .logo-text::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(0,212,255,.85), rgba(255,255,255,.95));
      mix-blend-mode: screen; opacity:0; pointer-events:none;
      animation: logoSweep 1.1s ease forwards .25s;
    }

    .nav-links a{
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 0.95rem;
      color: #e9f7ff;
      text-decoration:none;
      margin-left:18px;
      transition: color .25s ease;
    }
    .nav-links a:hover{ color:#fff; }

    .nav-actions{
      display:flex;
      align-items:center;
      gap: clamp(0.6rem, 1.2vw, 1.1rem);
    }

    .nav-cart{
      background: linear-gradient(180deg, rgba(203, 176, 255, 0.34), rgba(157, 121, 231, 0.26));
      border: 1px solid rgba(218, 192, 255, 0.62);
      padding: 0.5em 1em;
      color: #f8f1ff;
      box-shadow: 0 8px 22px rgba(148, 109, 220, 0.25);
    }

    .booking{
      max-width: min(98vw, 1820px);
      margin: 0 auto;
      padding: clamp(14px, 2.8vw, 36px) clamp(24px, 4.2vw, 56px) clamp(24px, 4.2vw, 56px);
    }

    .stepper-wrap{
      width: 100%;
      display:flex;
      justify-content:center;
      margin-top: 4px;
    }
    .stepper{
      list-style: none; padding: 12px; margin: 0;
      width: min(100%, 1080px);
      display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 28px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
      text-transform: lowercase;
    }
    .stepper li{
      padding: 12px 10px; text-align: center; border-radius: 16px;
      font-weight: 600; color: #efe8ff;
      border: 1px solid rgba(204, 173, 255, 0.45);
      background: linear-gradient(180deg, rgba(154, 119, 228, 0.28), rgba(124, 89, 203, 0.16));
      transition: transform .2s ease, background .2s ease, color .2s ease, border-color .2s ease;
      cursor: default;
    }
    .stepper li.clickable{
      cursor: pointer;
    }
    .stepper li.clickable:focus-visible{
      outline: 2px solid rgba(255,255,255,0.7);
      outline-offset: 2px;
    }
    .stepper li.done{
      color: #f6efff;
      border-color: rgba(204, 173, 255, 0.72);
      background: linear-gradient(180deg, rgba(175, 138, 245, 0.5), rgba(146, 109, 220, 0.32));
    }
    .stepper li.active{
      color: #fff;
      background: linear-gradient(180deg, #d8b7ff, #b88cff);
      border-color: rgba(229, 210, 255, 0.95);
      box-shadow: 0 12px 34px rgba(169, 123, 255, 0.34), 0 0 18px rgba(200, 168, 255, 0.42);
      transform: translateY(-1px);
    }



    @media (max-width: 900px){
      .stepper-wrap{
        overflow-x: auto;
        justify-content: flex-start;
      }
      .stepper{
        min-width: 980px;
      }
    }

    .booking-card{
      margin: 18px auto 0;
      width: min(100%, 1820px);
      background: rgba(10, 12, 16, 0.72);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 64px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.45);
      backdrop-filter: blur(8px);
      overflow: visible;
    }
    .booking-layout{
      display: flex;
      flex-direction: column;
      gap: clamp(24px, 3.6vw, 40px);
      padding: clamp(28px, 3.8vw, 48px);
    }
    .booking-form{
      padding: 0;
    }

    .form-columns{
      display: grid;
      gap: clamp(28px, 4.6vw, 54px);
      align-items: stretch;
      grid-template-columns: minmax(0, 1fr);
      grid-auto-rows: minmax(0, auto);
    }

    .form-columns.cart-summary-hidden{
      grid-template-columns: 1fr !important;
    }

    .form-steps{
      display: grid;
      gap: clamp(20px, 3.2vw, 32px);
      min-width: 0;
      max-width: 1040px;
      padding-bottom: clamp(24px, 4vw, 48px);
    }
    .form-steps > *{
      min-width: 0;
    }

    .step-extras-layout{
      display: grid;
      gap: clamp(18px, 2.6vw, 26px);
    }

    .step-extras-content{
      display: grid;
      gap: clamp(14px, 2.2vw, 20px);
      width: 100%;
    }

    @media (min-width: 1100px){
      .step-extras-content{
        max-height: none;
        overflow: visible;
        padding-right: 0;
      }
    }

    @keyframes floatFade{
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulseGlow{
      0%, 100% { transform: translateY(-40%) scale(1); opacity: 0.65; }
      50% { transform: translateY(-36%) scale(1.05); opacity: 0.85; }
    }
    .booking-success{ padding: clamp(16px, 3vw, 28px); }

    fieldset{ border: none; margin: 0; padding: 0; }
    legend{ font-weight: 800; font-size: 1.2rem; margin-bottom: 14px; }
    .muted{ color: #b6c2cf; }
    .frequency-note{ margin-top: 12px; }
    .legend-note{
      display: block;
      margin-top: 4px;
      font-size: 0.9rem;
      font-weight: 400;
      color: #b6c2cf;
    }

    .schedule-calendar{
      margin-top: clamp(18px, 3vw, 28px);
      border-radius: 28px;
      border: 1px solid rgba(154, 212, 255, 0.28);
      background: linear-gradient(145deg, rgba(10, 24, 40, 0.82), rgba(14, 32, 54, 0.88));
      box-shadow: 0 18px 46px rgba(0,0,0,0.42);
      padding: clamp(18px, 3vw, 28px);
      display: grid;
      gap: clamp(16px, 2.4vw, 24px);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .schedule-calendar::before{
      content: "";
      position: absolute;
      inset: -40% -20% auto -20%;
      height: 65%;
      border-radius: 60%;
      background: radial-gradient(circle at center, rgba(76, 195, 255, 0.18), transparent 70%);
      filter: blur(28px);
      opacity: 0.65;
      pointer-events: none;
      animation: calendarGlow 6s ease-in-out infinite alternate;
    }

    @keyframes calendarGlow{
      0%{ transform: translateY(0); opacity: 0.5; }
      100%{ transform: translateY(12px) scale(1.05); opacity: 0.8; }
    }

    .calendar-top{
      display: flex;
      flex-wrap: wrap;
      gap: clamp(12px, 2vw, 18px);
      align-items: flex-start;
      justify-content: space-between;
    }

    .calendar-heading{
      display: grid;
      gap: 6px;
      max-width: min(100%, 420px);
    }

    .calendar-heading h3{
      margin: 0;
      font-size: clamp(1.05rem, 2vw, 1.3rem);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .calendar-heading p{
      margin: 0;
      color: #b9d8f2;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .calendar-nav{
      display: inline-flex;
      align-items: center;
      gap: 12px;
      border-radius: 999px;
      border: 1px solid rgba(154, 212, 255, 0.22);
      background: rgba(6, 18, 32, 0.65);
      padding: 6px 10px;
      box-shadow: inset 0 0 0 1px rgba(76,195,255,0.12);
    }

    .calendar-current{
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 0.85rem;
      color: #e8f7ff;
    }

    .calendar-nav-btn{
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid rgba(154, 212, 255, 0.32);
      background: rgba(7, 24, 40, 0.85);
      color: #9ad4ff;
      display: grid;
      place-items: center;
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }

    .calendar-nav-btn:hover,
    .calendar-nav-btn:focus-visible{
      border-color: rgba(255, 144, 220, 0.55);
      color: #fff;
      box-shadow: 0 8px 18px rgba(76,195,255,0.35);
      transform: translateY(-1px);
      outline: none;
    }

    .calendar-nav-btn:disabled{
      opacity: 0.35;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .calendar-body{
      display: grid;
      gap: 10px;
    }

    .calendar-weekdays{
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(173, 214, 255, 0.68);
    }

    .calendar-weekdays span{
      display: grid;
      place-items: center;
      padding: 6px 0;
    }

    .calendar-grid{
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
      animation: calendarFade 0.35s ease;
    }

    @keyframes calendarFade{
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .calendar-cell{
      min-height: 52px;
      display: grid;
      place-items: center;
    }

    .calendar-cell--empty{ opacity: 0.2; }

    .calendar-day{
      width: 100%;
      height: 100%;
      border-radius: 16px;
      border: 1px solid rgba(154, 212, 255, 0.2);
      background: rgba(6, 18, 32, 0.78);
      color: #e8f7ff;
      font-weight: 600;
      font-size: 0.95rem;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .calendar-day:hover,
    .calendar-day:focus-visible{
      border-color: rgba(255, 144, 220, 0.55);
      background: rgba(18, 36, 60, 0.92);
      box-shadow: 0 12px 26px rgba(76,195,255,0.32);
      transform: translateY(-1px);
      outline: none;
    }

    .calendar-day.is-selected{
      background: linear-gradient(180deg, rgba(255, 144, 220, 0.35), rgba(255, 79, 195, 0.38));
      border-color: rgba(255, 144, 220, 0.65);
      color: #fff;
      box-shadow: 0 16px 40px rgba(255, 79, 195, 0.35);
      animation: calendarPop 0.3s ease;
    }

    .calendar-day.is-followup{
      background: linear-gradient(180deg, rgba(76,195,255,0.22), rgba(76,195,255,0.35));
      border-color: rgba(76,195,255,0.6);
      color: #f2fbff;
      box-shadow: 0 12px 32px rgba(76,195,255,0.28);
    }

    .calendar-day.is-selected::after{
      content: "Start";
      position: absolute;
      inset: auto 8px 6px 8px;
      font-size: 0.65rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.82);
    }

    .calendar-day.is-followup::after{
      content: "Next";
      position: absolute;
      inset: auto 8px 6px 8px;
      font-size: 0.65rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(214, 238, 255, 0.88);
    }

    @keyframes calendarPop{
      from { transform: scale(0.9); }
      to { transform: scale(1); }
    }

    .calendar-day.is-disabled,
    .calendar-day:disabled{
      cursor: not-allowed;
      opacity: 0.35;
      filter: grayscale(0.3);
    }

    .calendar-summary{
      display: grid;
      gap: 10px;
      background: rgba(6, 18, 32, 0.78);
      border: 1px solid rgba(154, 212, 255, 0.22);
      border-radius: 20px;
      padding: clamp(14px, 2.2vw, 20px);
      box-shadow: inset 0 0 0 1px rgba(76,195,255,0.08);
    }

    .calendar-summary-row{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      font-size: 0.95rem;
      color: #e8f7ff;
    }

    .calendar-summary-label{
      font-size: 0.75rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(173, 214, 255, 0.78);
    }

    .calendar-message{
      margin: 0;
      font-size: 0.85rem;
      color: rgba(173, 214, 255, 0.82);
    }

    .calendar-error{
      margin: 0;
      color: #ff98d6;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .cart-schedule{
      border-top: 1px dashed rgba(154, 212, 255, 0.22);
      padding-top: 12px;
      display: grid;
      gap: 10px;
      color: #dbeaff;
      font-size: 0.9rem;
    }

    .cart-schedule-row{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .cart-schedule-label{
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ad4ff;
    }

    .cart-schedule-row time{
      font-weight: 600;
    }

    .step-contact .grid-2{
      gap: clamp(18px, 2.6vw, 26px);
    }

    .step-contact label{
      background: linear-gradient(150deg, rgba(12, 26, 44, 0.82), rgba(20, 38, 60, 0.9));
      border: 1px solid rgba(154, 212, 255, 0.2);
      border-radius: 24px;
      padding: clamp(16px, 2.6vw, 26px);
      display: grid;
      gap: clamp(12px, 1.8vw, 18px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.38);
    }

    .step-contact .field-title{
      font-size: clamp(0.82rem, 1.4vw, 0.95rem);
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(173, 214, 255, 0.85);
      font-weight: 700;
    }

    .step-contact input,
    .step-contact textarea{
      background: rgba(6, 18, 30, 0.78);
      border: 1px solid rgba(154, 212, 255, 0.25);
      border-radius: 16px;
      padding: 0.85rem 1.1rem;
      color: #f4fbff;
      font-size: clamp(0.95rem, 1.6vw, 1.05rem);
      min-height: 54px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .step-contact textarea{
      min-height: 160px;
      resize: vertical;
    }

    .step-contact input:focus,
    .step-contact textarea:focus{
      border-color: rgba(255, 144, 220, 0.55);
      box-shadow: 0 0 0 2px rgba(255, 144, 220, 0.2);
      outline: none;
    }

    .summary-column{
      display: grid;
      gap: clamp(18px, 2.8vw, 26px);
      align-self: start;
      align-content: start;
      justify-self: end;
      max-width: min(100%, 420px);
      margin-top: 0;
    }
    .summary-column[hidden]{
      display: none !important;
    }
    .summary-column .cart-summary{
      margin: 0;
    }
    .cart-summary{
      background: rgba(7, 18, 32, 0.74);
      border: 1px solid rgba(255, 255, 255, 0.32);
      border-radius: 26px;
      padding: clamp(12px, 1.6vw, 18px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      display: grid;
      gap: clamp(10px, 1.6vw, 16px);
      width: 100%;
      max-width: 340px;
      min-width: 0;
      margin: 0;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    }
    .cart-summary.cart-summary-empty .cart-summary-subtitle{ color: #9ad4ff; }
    .cart-summary.cart-summary-empty .cart-pricing .cart-line span:last-child{ color: rgba(214, 238, 255, 0.6); }

    .cart-summary.is-added{
      border-color: rgba(255, 255, 255, 0.65);
      box-shadow: 0 20px 46px rgba(0,0,0,0.45), 0 0 0 2px rgba(255, 255, 255, 0.18);
      opacity: 0.96;
    }

    .cart-summary-flight{
      animation: cartSummaryFlight 0.65s ease;
    }

    .cart-summary header{
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .cart-summary img{
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.1);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }

    .cart-summary-title{
      margin: 0;
      font-family: "Bebas Neue", system-ui, sans-serif;
      font-size: clamp(20px, 3vw, 26px);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .cart-summary-subtitle{
      color: #b6c2cf;
      font-size: 0.85rem;
      margin: 2px 0 0;
    }

    .cart-details{
      font-size: 0.85rem;
      color: #99b3cc;
      line-height: 1.45;
    }
    .cart-detail-line{
      display: block;
      padding: 2px 0;
    }

    .cart-pricing{
      border-radius: 16px;
      border: 1px solid rgba(0, 212, 255, 0.2);
      background: rgba(4, 18, 28, 0.65);
      padding: 12px;
      display: grid;
      gap: 6px;
    }

    .cart-line{
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      color: #d7e7f8;
    }

    .cart-line.total{
      font-weight: 700;
      font-size: 1rem;
    }

    .cart-line.deposit{
      color: #00d084;
      font-weight: 600;
    }

    .cart-line.balance{
      color: #fbd38d;
    }

    .cart-divider{
      height: 1px;
      background: linear-gradient(90deg, rgba(0,212,255,0), rgba(0,212,255,0.45), rgba(0,212,255,0));
      margin: 2px 0;
    }

    @keyframes cartSummaryFlight{
      0% { transform: translateY(0); opacity: 1; }
      40% { transform: translateY(-6px); opacity: 0.92; }
      100% { transform: translateY(0); opacity: 1; }
    }

    .cart-btn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 700;
      background: linear-gradient(180deg, #d8b7ff, #b88cff);
      border-color: rgba(221, 196, 255, 0.88);
      color: #fff;
      box-shadow: 0 12px 30px rgba(165, 122, 242, 0.35);
    }

    .cart-btn:disabled{
      background: linear-gradient(180deg, rgba(216, 183, 255, 0.24), rgba(184, 140, 255, 0.18));
      border-color: rgba(205, 176, 255, 0.36);
      color: rgba(255,255,255,0.72);
      box-shadow: none;
    }

    .cart-btn.is-added{
      background: linear-gradient(180deg, #e2c7ff, #c69cff);
      border-color: rgba(230, 212, 255, 0.9);
      color: #fff;
    }

    .cart-btn-icon{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.2rem;
      height: 1.2rem;
    }

    .cart-btn-icon svg{ width: 100%; height: 100%; }

    .cart-btn.is-added .cart-btn-icon{
      filter: drop-shadow(0 0 6px rgba(255, 160, 224, 0.55));
    }

    .cart-status{
      min-height: 1em;
      font-size: 0.9rem;
      color: #9ad4ff;
    }

    .cart-status.error{ color: #ff6b9a; }

    .grid-2{ display: grid; gap: 14px; grid-template-columns: 1fr; }
    .grid-2 .wide{ grid-column: 1 / -1; }
    @media (min-width: 720px){ .grid-2{ grid-template-columns: 1fr 1fr; } }

    label{ display:flex; flex-direction:column; gap:6px; font-size: .95rem; }
    input, select, textarea{
      border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); padding: 12px 12px;
      background: rgba(255,255,255,0.05); color: #f2f5f8; outline: none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(76,195,255,0.7);
      box-shadow: 0 0 0 3px rgba(76,195,255,0.25);
      background: rgba(255,255,255,0.08);
    }

    .plans{ display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    @media (min-width: 840px){ .plans{ grid-template-columns: repeat(3, minmax(240px, 1fr)); } }
    .plan{ display:block; }
    .plan input{ display:none; }
    .plan-card{
      border: 2px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: clamp(18px, 2.6vw, 26px);
      background: rgba(255,255,255,0.04);
      transition: transform .2s ease, border-color .2s ease, background .2s ease, box-shadow .2s ease;
      min-height: 148px;
    }
    .plan-card:hover{
      border-color: rgba(0,212,255,0.45);
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      transform: translateY(-1px);
    }
    .plan input:focus-visible + .plan-card{
      outline: 2px solid rgba(0,212,255,0.65);
      outline-offset: 3px;
    }
    .plan input:checked + .plan-card{
      border-color: rgba(0,208,132,0.75);
      background: linear-gradient(180deg, rgba(0,208,132,0.18), rgba(0,208,132,0.08));
      box-shadow: 0 18px 36px rgba(0,208,132,0.18);
      transform: translateY(-2px);
    }
    .plan-title{ font-weight: 800; }
    .plan-discount{ color: #00d084; font-weight: 700; }
    .plan-note{ color: #b6c2cf; font-size: .9rem; }

    .actions{ margin-top: 18px; display:flex; gap:10px; justify-content:flex-start; flex-wrap: wrap; }
    .btn{
      appearance: none; border: 1px solid rgba(255,255,255,0.08); color: #0b0d10;
      background: linear-gradient(180deg, #4cc3ff, #00e0a4);
      font-weight: 800; border-radius: 12px; padding: 10px 16px; cursor: pointer;
    }
    .btn.next{
      background: linear-gradient(135deg, #ff9adb, #ff4fc3);
      color: #fff;
      border-color: rgba(255,255,255,0.18);
      position: fixed;
      right: clamp(16px, 4vw, 48px);
      bottom: clamp(20px, 5vw, 52px);
      padding: clamp(12px, 2.6vw, 18px) clamp(28px, 5vw, 40px);
      border-radius: 999px;
      box-shadow: 0 22px 50px rgba(255, 79, 195, 0.32);
      z-index: 980;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }
    .btn.next:hover{
      transform: translateY(-2px);
      box-shadow: 0 28px 58px rgba(255, 79, 195, 0.42);
    }
    .btn.next:disabled{
      opacity: 0.6;
      box-shadow: none;
      transform: none;
    }
    .btn.back{
      background: rgba(255,255,255,0.06); color: #f2f5f8;
    }
    .btn.skip{
      background: rgba(255,255,255,0.08);
      color: #e9f7ff;
      border-color: rgba(255,255,255,0.18);
    }
    .btn:hover{ filter: brightness(1.05); }

    .review{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 8px 12px;
      border: 1px solid rgba(215, 193, 255, 0.42);
      background: rgba(150, 118, 214, 0.14);
      border-radius: 14px;
      padding: 12px;
      align-items: center;
    }
    .review dt{
      font-weight: 700;
      color: #dfd1ff;
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin: 0;
    }
    .review dd{
      margin: 0;
      color: #ffffff;
      font-size: 0.9rem;
      line-height: 1.35;
    }

    .payment-section{
      margin-top: 18px;
      display: grid;
      gap: 12px;
    }

    .payment-section h3{
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #e9f7ff;
    }

    .payment-options{
      display: grid;
      gap: 12px;
    }

    .payment-option{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(7, 18, 32, 0.62);
      cursor: pointer;
    }

    .payment-option input{
      accent-color: #ffffff;
      transform: scale(1.05);
    }

    .payment-label{
      font-weight: 600;
      color: #f3f7fb;
    }

    .card-logos{
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .card-logo{
      width: 46px;
      height: 28px;
      border-radius: 6px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .card-logo svg{
      width: 36px;
      height: 18px;
      display: block;
    }

    .payment-ui{
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,0.2);
      padding: 12px;
      background: rgba(5, 14, 24, 0.6);
    }

    .paypal-status{
      margin: 8px 0 0;
      font-size: 0.9rem;
      color: #b6c2cf;
    }

    .paypal-status.error{
      color: #ff6b9a;
    }

    .stripe-help{
      margin: 0 0 10px;
    }

    .stripe-checkout-btn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: #6c4bf4;
      color: #ffffff;
      text-decoration: none;
      font-weight: 600;
    }

    .stripe-checkout-btn[aria-disabled="true"]{
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }

    .stripe-status{
      margin: 8px 0 0;
      font-size: 0.9rem;
      color: #b6c2cf;
    }

    .stripe-status.error{
      color: #ff6b9a;
    }

    .stripe-reference{
      display: grid;
      gap: 6px;
      margin-top: 12px;
    }

    .addon-empty{ color: rgba(214, 238, 255, 0.7); font-size: 0.95rem; }

    @media (min-width: 780px){
      .form-columns{
        grid-template-columns: minmax(0, 2.4fr) minmax(320px, 0.85fr);
        gap: clamp(52px, 6.4vw, 88px);
        align-items: start;
      }
      .form-columns > .form-steps{
        grid-column: 1 / 2;
        grid-row: 1;
      }
      .form-columns > #summaryColumn{
        grid-column: 2 / 3;
        grid-row: 1;
        align-self: start;
      }
      .summary-column{
        position: sticky;
        top: clamp(24px, 3.6vw, 46px);
        max-height: calc(100vh - 80px);
        overflow: auto;
        padding-right: 4px;
        align-content: start;
        gap: clamp(18px, 2.8vw, 26px);
        width: min(100%, 420px);
      }
      .summary-column .cart-summary{
        position: static;
        max-height: none;
        overflow: visible;
        justify-self: stretch;
        margin: 0;
      }
    }
    @media (min-width: 960px){
      .form-steps{ max-width: 1120px; }
    }
    @media (min-width: 1120px){
      .form-columns{
        grid-template-columns: minmax(0, 2.6fr) minmax(360px, 0.85fr);
        gap: clamp(66px, 7vw, 112px);
      }
      .plans{ grid-template-columns: repeat(3, minmax(260px, 1fr)); }
      .summary-column{
        max-width: 420px;
      }
    }

    .step-frequency .plans{ margin-bottom: 0; }
  </style>
</head>
<body id="i1id"
  data-paypal-client-id="AQk9lOYg8zcKM_lzMRRsenVn-6dsBDLcj19FZEfH_lyWi78RuZJnh9jtInuutAfuZ6JLfRe1cu-ihq7X"
  data-paypal-currency="CAD"
  data-cart-image="deepcleanpackage.png"
  data-stripe-checkout-endpoint="/.netlify/functions/create-checkout-session">
  <header class="navbar">
    <div class="logo">
      <span class="soap">üßº</span>
      <a class="logo-text" href="index.html">DufferinDeepClean</a>
    </div>
    <nav class="nav-links">
      <a href="index.html#home">Home</a>
      <a href="index.html#services">Services</a>
      <a href="about.html">About Us</a>
      <a href="contact.html">Contact</a>
      <a href="book.html#start" class="quote-btn" aria-current="page">Book Online</a>
    </nav>
    <div class="nav-actions">
      <button class="nav-cart" type="button" data-cart-toggle aria-haspopup="dialog" aria-controls="navCartPopover" aria-expanded="false">
        <span class="nav-cart-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
            <path d="M4.5 4h-2a.5.5 0 0 1 0-1h2.8a1 1 0 0 1 .97.76L6.7 6H21a1 1 0 0 1 .96 1.27l-2 7A1 1 0 0 1 19 15H9.24l-.78 2.34A1 1 0 0 1 7.52 18H4.5a.5.5 0 0 1 0-1h2.55l3.2-9.6L9.8 6H4.78a1 1 0 0 1-.95-.68L4.5 4Zm4.28 3-2.4 7.2H19.1l1.71-6H8.78ZM9 19.75a1.75 1.75 0 1 1-3.5 0 1.75 1.75 0 0 1 3.5 0Zm9.5 0a1.75 1.75 0 1 1-3.5 0 1.75 1.75 0 0 1 3.5 0Z" fill="currentColor"/>
          </svg>
        </span>
        <span class="nav-cart-label">Cart</span>
        <span class="nav-cart-count" data-cart-count hidden>0</span>
      </button>
    </div>
  </header>
  <aside class="nav-cart-popover" id="navCartPopover" role="dialog" aria-modal="false" aria-label="Cart summary" hidden>
    <div class="nav-cart-popover-inner">
      <button type="button" class="cart-popover-close" data-cart-close aria-label="Close cart">
        <span aria-hidden="true">&times;</span>
      </button>
      <header class="cart-popover-header">
        <img data-cart-popover-image alt="Cart package preview" loading="lazy" />
        <div>
          <p class="cart-popover-title" data-popover-service>Your cart is empty</p>
          <p class="cart-popover-subtitle" data-popover-frequency>Build a package to see pricing here.</p>
        </div>
      </header>
      <p class="cart-popover-status" data-popover-status hidden></p>
      <p class="cart-popover-empty" data-popover-empty>Use ‚ÄúBook Online‚Äù to customise your cleaning package.</p>
      <dl class="cart-popover-details" data-popover-details hidden></dl>
      <div class="cart-popover-totals" data-popover-totals hidden>
        <div><span>Visit total</span><span data-popover-total>‚Äî</span></div>
      </div>
      <div class="cart-popover-payments" data-popover-payments hidden>
        <div id="nav-paypal-buttons" data-paypal-container="nav"></div>
        <p class="cart-popover-paypal-status" id="nav-paypal-status" role="status" aria-live="polite"></p>
        <button type="button" class="btn cart-popover-google" data-google-pay-button disabled>Google Pay (coming soon)</button>
      </div>
    </div>
  </aside>

  <section class="booking" id="start">
    <div class="stepper-wrap">
      <ol class="stepper" id="stepper">
        <li class="active" data-stepper-label="schedule &amp; frequency">1. schedule &amp; frequency</li>
        <li data-stepper-label="optional services" data-stepper-optional>2. optional services</li>
        <li data-stepper-label="your details">3. your details</li>
        <li data-stepper-label="review &amp; confirm">4. review &amp; confirm</li>
      </ol>
    </div>

    <div class="booking-card">
      <div class="booking-layout" id="bookingLayout">
                <form id="bookingForm" class="booking-form" action="https://formspree.io/f/mrblyqpr" method="POST">

          <input type="hidden" name="service_key" id="input-service-key">
          <input type="hidden" name="service_label" id="input-service-label">
          <input type="hidden" name="square_footage_range" id="input-sqft-label">
          <input type="hidden" name="detail_summary" id="input-detail-summary">
          <input type="hidden" name="base_package_price" id="input-base-price">
          <input type="hidden" name="service_detail_price" id="input-detail-price">
          <input type="hidden" name="addons_price" id="input-addons-price">
          <input type="hidden" name="frequency_savings" id="input-discount-price">
          <input type="hidden" name="final_visit_total" id="input-total-price">
          <input type="hidden" name="selected_addons" id="input-selected-addons">
          <input type="hidden" name="origin_quote" id="input-origin" value="">
          <input type="hidden" name="package" id="input-package">
          <input type="hidden" name="paypal_order_id" id="input-paypal-order-id">
          <input type="hidden" name="paypal_payer_id" id="input-paypal-payer-id">
          <input type="hidden" name="paypal_capture_id" id="input-paypal-capture-id">
          <input type="hidden" name="cart_status" id="input-cart-status" value="pending">
          <input type="hidden" name="name" id="input-full-name" value="">
          <input type="hidden" name="first_visit_date" id="input-first-visit-date" value="">
          <input type="hidden" name="follow_up_visit_date" id="input-follow-up-date" value="">

          <div class="form-columns">
            <div class="form-steps">

        

        <fieldset class="step step-frequency" data-step="1">
          <legend>Choose your visit frequency</legend>
          <div class="plans">
            <label class="plan">
              <input type="radio" name="frequency" value="weekly" data-discount="0.25" required />
              <div class="plan-card">
                <div class="plan-title">Weekly</div>
                <div class="plan-discount">25% off</div>
                <div class="plan-note">Best value &amp; consistency</div>
              </div>
            </label>
            <label class="plan">
              <input type="radio" name="frequency" value="biweekly" data-discount="0.20" />
              <div class="plan-card">
                <div class="plan-title">Bi-Weekly</div>
                <div class="plan-discount">20% off</div>
                <div class="plan-note">Great for busy offices</div>
              </div>
            </label>
            <label class="plan">
              <input type="radio" name="frequency" value="triweekly" data-discount="0.15" />
              <div class="plan-card">
                <div class="plan-title">Tri-Weekly</div>
                <div class="plan-discount">15% off</div>
                <div class="plan-note">Light traffic spaces</div>
              </div>
            </label>
            <label class="plan">
              <input type="radio" name="frequency" value="monthly" data-discount="0.10" />
              <div class="plan-card">
                <div class="plan-title">Monthly</div>
                <div class="plan-discount">10% off</div>
                <div class="plan-note">Deep refresh once a month</div>
              </div>
            </label>
            <label class="plan">
              <input type="radio" name="frequency" value="biannual" data-discount="0.05" />
              <div class="plan-card">
                <div class="plan-title">Biannual</div>
                <div class="plan-discount">5% off</div>
                <div class="plan-note">Seasonal top-to-bottom</div>
              </div>
            </label>
            <label class="plan">
              <input type="radio" name="frequency" value="onetime" data-discount="0" />
              <div class="plan-card">
                <div class="plan-title">One-time</div>
                <div class="plan-discount">Standard rate</div>
                <div class="plan-note">Perfect for move-ins &amp; projects</div>
              </div>
            </label>
          </div>
          <p class="muted frequency-note">Your cart on the right keeps a live tally of the package and frequency savings.</p>
          <div class="schedule-calendar" data-schedule-calendar>
            <div class="calendar-top">
              <div class="calendar-heading">
                <h3>Schedule your visits</h3>
                <p>Select a starting date to preview when we‚Äôll be back based on your chosen frequency.</p>
              </div>
              <div class="calendar-nav" role="group" aria-label="Change month">
                <button type="button" class="calendar-nav-btn" data-calendar-prev aria-label="Previous month">‚Äπ</button>
                <div class="calendar-current" data-calendar-month>Month</div>
                <button type="button" class="calendar-nav-btn" data-calendar-next aria-label="Next month">‚Ä∫</button>
              </div>
            </div>
            <div class="calendar-body">
              <div class="calendar-weekdays" aria-hidden="true">
                <span>Sun</span>
                <span>Mon</span>
                <span>Tue</span>
                <span>Wed</span>
                <span>Thu</span>
                <span>Fri</span>
                <span>Sat</span>
              </div>
              <div class="calendar-grid" data-calendar-grid aria-live="polite" aria-label="Select your first visit date"></div>
            </div>
            <div class="calendar-summary" aria-live="polite">
              <div class="calendar-summary-row">
                <span class="calendar-summary-label">First visit</span>
                <time data-calendar-selected>‚Äî</time>
              </div>
              <div class="calendar-summary-row" data-calendar-follow-up-row hidden>
                <span class="calendar-summary-label">Next visit</span>
                <time data-calendar-follow-up>‚Äî</time>
              </div>
              <p class="calendar-message" data-calendar-message>Pick your starting date to preview your recurring visits.</p>
            </div>
            <p class="calendar-error" id="calendarError" role="alert" hidden>Please choose a starting visit date before continuing.</p>
          </div>
          <div class="actions">
            <button type="button" class="btn next">Next</button>
          </div>
        </fieldset>

        <fieldset class="step step-extras" data-step="2" data-step-optional hidden>
          <legend>Optional services <span class="legend-note">Add-ons are available for the house cleaning package.</span></legend>
          <div class="step-extras-layout">
            <div class="step-extras-content">
              <div class="addon-groups">
                <div class="addon-group addon-group--services" data-service-group="home">
                  <button type="button" class="addon-pill addon-pill--media color-cyan" data-addon="Cabinet cleaning" data-price="25" style="--delay: 0s;">
                    <span class="addon-thumb">
                      <img src="cabinet.png" alt="Cabinet cleaning add-on" loading="lazy">
                    </span>
                    <span class="addon-ghost-controls" aria-hidden="true">‚àí +</span>
                    <span class="addon-details">
                      <span class="addon-name">Cabinet cleaning</span>
                      <span class="addon-meta">
                        <span class="addon-price">$25 base</span>
                        <span class="addon-desc">Exterior wipe-down</span>
                      </span>
                    </span>
                  </button>
                  <button type="button" class="addon-pill addon-pill--media color-mint" data-addon="Baseboard detailing" data-price="20" style="--delay: 0.05s;">
                    <span class="addon-thumb">
                      <img src="baseboards.png" alt="Baseboard detailing add-on" loading="lazy">
                    </span>
                    <span class="addon-ghost-controls" aria-hidden="true">‚àí +</span>
                    <span class="addon-details">
                      <span class="addon-name">Baseboard detailing</span>
                      <span class="addon-meta">
                        <span class="addon-price">$20 base</span>
                        <span class="addon-desc">Dust + shine</span>
                      </span>
                    </span>
                  </button>
                  <button type="button" class="addon-pill addon-pill--media color-lavender" data-addon="Refrigerator refresh" data-price="30" style="--delay: 0.1s;">
                    <span class="addon-thumb">
                      <img src="refrigerator.png" alt="Refrigerator refresh add-on" loading="lazy">
                    </span>
                    <span class="addon-ghost-controls" aria-hidden="true">‚àí +</span>
                    <span class="addon-details">
                      <span class="addon-name">Refrigerator refresh</span>
                      <span class="addon-meta">
                        <span class="addon-price">$30 base</span>
                        <span class="addon-desc">Shelves + handles</span>
                      </span>
                    </span>
                  </button>
                  <button type="button" class="addon-pill addon-pill--media color-amber" data-addon="Appliance polish" data-price="40" style="--delay: 0.15s;">
                    <span class="addon-thumb">
                      <img src="appliances.png" alt="Appliance polish add-on" loading="lazy">
                    </span>
                    <span class="addon-ghost-controls" aria-hidden="true">‚àí +</span>
                    <span class="addon-details">
                      <span class="addon-name">Appliance polish</span>
                      <span class="addon-meta">
                        <span class="addon-price">$40 base</span>
                        <span class="addon-desc">Stainless shine</span>
                      </span>
                    </span>
                  </button>
                  <button type="button" class="addon-pill addon-pill--media color-rose" data-addon="Oven deep clean" data-price="35" style="--delay: 0.2s;">
                    <span class="addon-thumb">
                      <img src="oven.png" alt="Oven deep clean add-on" loading="lazy">
                    </span>
                    <span class="addon-ghost-controls" aria-hidden="true">‚àí +</span>
                    <span class="addon-details">
                      <span class="addon-name">Oven deep clean</span>
                      <span class="addon-meta">
                        <span class="addon-price">$35 base</span>
                        <span class="addon-desc">Inside + glass</span>
                      </span>
                    </span>
                  </button>
                  <button type="button" class="addon-pill addon-pill--media color-sky" data-addon="Window detailing" data-price="35" style="--delay: 0.25s;">
                    <span class="addon-thumb">
                      <img src="window.png" alt="Window detailing add-on" loading="lazy">
                    </span>
                    <span class="addon-ghost-controls" aria-hidden="true">‚àí +</span>
                    <span class="addon-details">
                      <span class="addon-name">Window detailing</span>
                      <span class="addon-meta">
                        <span class="addon-price">$35 base</span>
                        <span class="addon-desc">Interior glass</span>
                      </span>
                    </span>
                  </button>
                </div>
              </div>
              <p class="addon-empty" id="addon-empty-message" hidden>Optional services are only available for the house cleaning package.</p>
            </div>
          </div>
          <div class="actions">
            <button type="button" class="btn back">Back</button>
            <button type="button" class="btn next">Next</button>
          </div>
        </fieldset>

        <fieldset class="step step-contact" data-step="3" hidden>
          <legend>Your contact information</legend>
          <div class="grid-2">
            <label>
              <span class="field-title">First name</span>
              <input type="text" name="first_name" placeholder="Jane" autocomplete="given-name" required />
            </label>
            <label>
              <span class="field-title">Last name (optional)</span>
              <input type="text" name="last_name" placeholder="Smith" autocomplete="family-name" />
            </label>
            <label>
              <span class="field-title">Email</span>
              <input type="email" name="email" placeholder="you@company.com" autocomplete="email" required />
            </label>
            <label>
              <span class="field-title">Phone</span>
              <input type="tel" name="phone" placeholder="(555) 555-5555" autocomplete="tel" />
            </label>
            <label class="wide">
              <span class="field-title">Notes (optional)</span>
              <textarea name="notes" rows="3" placeholder="Access details, special instructions, etc."></textarea>
            </label>
          </div>
          <div class="actions">
            <button type="button" class="btn back">Back</button>
            <button type="button" class="btn next">Next</button>
          </div>
        </fieldset>

        <fieldset class="step" data-step="4" hidden>
          <legend>Review &amp; confirm</legend>
          <p class="muted">Double-check every detail below, then finalize your booking when you're ready. Your cart summary stays on the right for a quick final check.</p>
          <dl class="review" id="reviewList"></dl>
          <div class="payment-section">
            <h3>Payment method</h3>
            <div class="payment-options">
              <label class="payment-option">
                <span class="payment-label">PayPal</span>
                <input type="radio" name="payment_method" value="paypal" />
              </label>
              <label class="payment-option">
                <span class="payment-label">Card (Stripe)</span>
                <span class="card-logos" aria-hidden="true">
                  <span class="card-logo">
                    <svg viewBox="0 0 64 32" role="presentation" focusable="false" aria-hidden="true">
                      <rect x="0" y="0" width="64" height="32" rx="6" fill="#1a3df0"/>
                      <text x="32" y="21" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="14" font-weight="700" fill="#ffffff">VISA</text>
                    </svg>
                  </span>
                  <span class="card-logo">
                    <svg viewBox="0 0 64 32" role="presentation" focusable="false" aria-hidden="true">
                      <rect x="0" y="0" width="64" height="32" rx="6" fill="#111827"/>
                      <circle cx="26" cy="16" r="10" fill="#ff5f00"/>
                      <circle cx="38" cy="16" r="10" fill="#eb001b" opacity="0.9"/>
                    </svg>
                  </span>
                </span>
                <input type="radio" name="payment_method" value="card" checked />
              </label>
            </div>
            <div class="payment-ui" data-payment-ui="paypal" hidden>
              <div id="paypal-buttons"></div>
              <p class="paypal-status" id="paypal-status" role="status" aria-live="polite"></p>
            </div>
            <div class="payment-ui" data-payment-ui="stripe" hidden>
              <p class="muted stripe-help">Card payments are processed securely through Stripe. Click below to create a live checkout from this cart total. After payment, you'll return here with your Stripe session ID filled in.</p>
              <button type="button" class="btn stripe-checkout-btn" id="stripe-checkout-btn">Pay with Stripe Checkout</button>
              <p class="stripe-status" id="stripe-status" role="status" aria-live="polite" hidden></p>
              <label class="stripe-reference">
                <span class="field-title">Stripe receipt / session ID</span>
                <input type="text" name="stripe_reference" id="stripe-reference-input" placeholder="e.g. cs_test_123 or pi_123" />
              </label>
            </div>
          </div>
          <div class="actions">
            <button type="button" class="btn back">Back</button>
            <button type="submit" class="btn submit">Submit</button>
          </div>
        </fieldset>

            </div>

            <aside class="summary-column" id="summaryColumn" aria-label="Package overview and cart">
              <div class="cart-summary" id="cartSummary" aria-label="Cart summary">
                <header>
                  <img id="cartSummaryImage" alt="House cleaning package preview" loading="lazy" />
                  <div>
                    <h2 class="cart-summary-title">House Cleaning Package</h2>
                    <p class="cart-summary-subtitle" data-cart-service>Choose a service to view details.</p>
                  </div>
                </header>
                <div class="cart-details" data-cart-description hidden></div>
                <div class="cart-pricing" id="pricingRecap">
                  <div class="cart-line">
                    <span>Base package</span>
                    <span data-recap-base>‚Äî</span>
                  </div>
                  <div class="cart-line" data-recap-detail-row hidden>
                    <span>Service details</span>
                    <span data-recap-detail>‚Äî</span>
                  </div>
                  <div class="cart-line" data-recap-extras-row hidden>
                    <span>Add-ons</span>
                    <span data-recap-extras>‚Äî</span>
                  </div>
                  <div class="cart-line" data-recap-discount-row hidden>
                    <span>Frequency savings</span>
                    <span data-recap-discount>‚Äî</span>
                  </div>
                  <div class="cart-divider"></div>
                  <div class="cart-line total">
                    <span>Visit total</span>
                    <span data-recap-total>‚Äî</span>
                  </div>
                </div>
                <div class="cart-schedule" id="cartSchedule" hidden aria-live="polite">
                  <div class="cart-schedule-row">
                    <span class="cart-schedule-label">First visit</span>
                    <time data-cart-first-visit>‚Äî</time>
                  </div>
                  <div class="cart-schedule-row" data-cart-next-row hidden>
                    <span class="cart-schedule-label">Next visit</span>
                    <time data-cart-next-visit>‚Äî</time>
                  </div>
                </div>
                <button type="button" class="btn cart-btn" id="addToCartBtn" disabled>
                  <span class="cart-btn-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                      <path d="M4.5 4h-2a.5.5 0 0 1 0-1h2.8a1 1 0 0 1 .97.76L6.7 6H21a1 1 0 0 1 .96 1.27l-2 7A1 1 0 0 1 19 15H9.24l-.78 2.34A1 1 0 0 1 7.52 18H4.5a.5.5 0 0 1 0-1h2.55l3.2-9.6L9.8 6H4.78a1 1 0 0 1-.95-.68L4.5 4Zm4.28 3-2.4 7.2H19.1l1.71-6H8.78ZM9 19.75a1.75 1.75 0 1 1-3.5 0 1.75 1.75 0 0 1 3.5 0Zm9.5 0a1.75 1.75 0 1 1-3.5 0 1.75 1.75 0 0 1 3.5 0Z" fill="currentColor"/>
                    </svg>
                  </span>
                  <span class="cart-btn-text">Add to Cart</span>
                </button>
                <p class="cart-status" id="cartStatus" role="status" aria-live="polite"></p>
              </div>
      
                    </section>
                  </div>
                </div>
              </div>
            </aside>

          </div>

        </form>

      </div>

      <div id="bookingSuccess" class="booking-success" hidden>
        <h2>Thanks! Your request has been received.</h2>
        <p>We‚Äôll get back to you within one business day to confirm your booking.</p>
        <a href="index.html" class="btn">Back to Home</a>
      </div>
    </div>
  </section>

  <script>
    (function () {
      var iOS = /iP(hone|od|ad)/.test(navigator.platform) || (navigator.userAgent.includes('Mac') && navigator.maxTouchPoints > 1);
      if (iOS) document.documentElement.classList.add('ios');
    })();
  </script>

  <script>
    (function(){
      const quoteForms = Array.from(document.querySelectorAll('form.quote-form'));
      if(!quoteForms.length) return;


      const basePricing = {
        home: {
          '1000-1500': 165,
          '1500-2000': 185,
          '2000-2500': 215,
          '2500-3000': 245,
          '3000-3500': 285,
          '3500-4000': 325,
          '4000-4500': 345,
          '4500-5000': 365,
          '5000-5500': 385,
          '5500-6000': 405,
          '6000-6500': 425,
          '6500-7000': 445,
          '7000-7500': 465,
          '7500-8000': 485,
          '8000-8500': 505,
          '8500-9000': 525,
          '9000-9500': 545,
          '9500-10000': 565,
          '10000-10500': 585,
          '10500-11000': 605,
          '11000-11500': 625,
          '11500-12000': 645,
          '12000-12500': 665,
          '12500-13000': 685,
          '13000-13500': 705,
          '13500-14000': 725,
          '14000-14500': 745,
          '14500-15000': 765,
          '15000-15500': 785,
          '15500-16000': 805,
          '16000-16500': 825,
          '16500-17000': 845,
          '17000-17500': 865,
          '17500-18000': 885,
          '18000-18500': 905,
          '18500-19000': 925,
          '19000-19500': 945,
          '19500-20000': 965
        },
        commercial: {
          '1000-1500': 240,
          '1500-2000': 285,
          '2000-2500': 330,
          '2500-3000': 380,
          '3000-3500': 425,
          '3500-4000': 470,
          '4000-4500': 495,
          '4500-5000': 520,
          '5000-5500': 545,
          '5500-6000': 570,
          '6000-6500': 595,
          '6500-7000': 620,
          '7000-7500': 645,
          '7500-8000': 670,
          '8000-8500': 695,
          '8500-9000': 720,
          '9000-9500': 745,
          '9500-10000': 770,
          '10000-10500': 795,
          '10500-11000': 820,
          '11000-11500': 845,
          '11500-12000': 870,
          '12000-12500': 895,
          '12500-13000': 920,
          '13000-13500': 945,
          '13500-14000': 970,
          '14000-14500': 995,
          '14500-15000': 1020,
          '15000-15500': 1045,
          '15500-16000': 1070,
          '16000-16500': 1095,
          '16500-17000': 1120,
          '17000-17500': 1145,
          '17500-18000': 1170,
          '18000-18500': 1195,
          '18500-19000': 1220,
          '19000-19500': 1245,
          '19500-20000': 1270
        },
        office: {
          '1000-1500': 210,
          '1500-2000': 250,
          '2000-2500': 295,
          '2500-3000': 335,
          '3000-3500': 375,
          '3500-4000': 420,
          '4000-4500': 442,
          '4500-5000': 464,
          '5000-5500': 486,
          '5500-6000': 508,
          '6000-6500': 530,
          '6500-7000': 552,
          '7000-7500': 574,
          '7500-8000': 596,
          '8000-8500': 618,
          '8500-9000': 640,
          '9000-9500': 662,
          '9500-10000': 684,
          '10000-10500': 706,
          '10500-11000': 728,
          '11000-11500': 750,
          '11500-12000': 772,
          '12000-12500': 794,
          '12500-13000': 816,
          '13000-13500': 838,
          '13500-14000': 860,
          '14000-14500': 882,
          '14500-15000': 904,
          '15000-15500': 926,
          '15500-16000': 948,
          '16000-16500': 970,
          '16500-17000': 992,
          '17000-17500': 1014,
          '17500-18000': 1036,
          '18000-18500': 1058,
          '18500-19000': 1080,
          '19000-19500': 1102,
          '19500-20000': 1124
        }
      };

      const detailPricing = {
        home: {
          rooms: { '1-2': 0, '3-4': 25, '5-6': 55, '7+': 85 },
          bathrooms: { '1': 0, '2': 18, '3': 36, '4+': 54 },
          pets: { no: 0, yes: 25 }
        },
        office: {
          offices: { '1-5': 0, '6-10': 45, '11-20': 90, '21+': 135 },
          bathrooms: { '1-2': 0, '3-4': 40, '5+': 70 }
        }
      };

      quoteForms.forEach(setupQuoteForm);

      function setupQuoteForm(form){
        const requiredFields = Array.from(form.querySelectorAll('[data-required]'));
        const basePriceEl = form.querySelector('[data-quote-base]');
        const detailRow = form.querySelector('[data-quote-detail-row]');
        const detailPriceEl = form.querySelector('[data-quote-detail]');
        const totalPriceEl = form.querySelector('[data-quote-total]');
        const serviceInput = form.querySelector('input[name="service"]');
        const sqftInput = form.querySelector('input[name="square-footage"]');
        const serviceDetailsWrapper = form.querySelector('.service-details');
        const detailGroups = serviceDetailsWrapper ? Array.from(serviceDetailsWrapper.querySelectorAll('[data-service-detail]')) : [];
        const seePriceBtn = form.querySelector('.quote-see-price');
        const pillControls = Array.from(form.querySelectorAll('[data-target-input]'));

        function fieldIsRelevant(field){
          const requirement = field.dataset.serviceRequired;
          if(!requirement) return true;
          const serviceKey = serviceInput ? serviceInput.value : '';
          if(!serviceKey) return false;
          return requirement.split(',').includes(serviceKey);
        }

        function hasAllRequired(){
          return requiredFields.every(field => {
            if(!fieldIsRelevant(field)) return true;
            const value = field.value ? field.value.trim() : '';
            if(field.type === 'email'){
              return value !== '' && value.includes('@');
            }
            return value !== '';
          });
        }

        function resetServiceGroup(group){
          const hiddenInputs = Array.from(group.querySelectorAll('input[type="hidden"]'));
          hiddenInputs.forEach(input => {
            input.value = '';
            input.dataset.label = '';
          });
          const buttons = Array.from(group.querySelectorAll('[data-target-input]'));
          buttons.forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-pressed', 'false');
          });
        }

        function updateServiceDetails(serviceKey){
          if(!serviceDetailsWrapper) return;
          let activeCount = 0;
          detailGroups.forEach(group => {
            const services = (group.dataset.serviceDetail || '').split(',');
            const match = serviceKey && services.includes(serviceKey);
            group.classList.toggle('active', !!match);
            group.setAttribute('aria-hidden', match ? 'false' : 'true');
            if(match){
              activeCount += 1;
            } else {
              resetServiceGroup(group);
            }
          });
          serviceDetailsWrapper.classList.toggle('visible', activeCount > 0);
          serviceDetailsWrapper.setAttribute('aria-hidden', activeCount > 0 ? 'false' : 'true');
        }

        function selectionInfo(input){
          if(!input || !input.value) return null;
          return {
            value: input.value,
            label: input.dataset.label || input.value
          };
        }

        function calculateTotals(){
          const serviceKey = serviceInput ? serviceInput.value : '';
          const sqftKey = sqftInput ? sqftInput.value : '';
          if(!serviceKey || !sqftKey || !basePricing[serviceKey]){
            return { ready: false, base: 0, detail: 0, total: 0, selections: {}, serviceLabel: '', sqftLabel: '' };
          }

          const base = basePricing[serviceKey][sqftKey] || 0;
          let detailAdjustment = 0;
          const selections = {};

          if(serviceKey === 'home'){
            const roomsField = form.querySelector('input[name="home-rooms"]');
            const bathsField = form.querySelector('input[name="home-bathrooms"]');
            const petsField = form.querySelector('input[name="home-pets"]');

            const roomsInfo = selectionInfo(roomsField);
            const bathsInfo = selectionInfo(bathsField);
            const petsInfo = selectionInfo(petsField);

            if(roomsInfo){
              detailAdjustment += detailPricing.home.rooms[roomsInfo.value] || 0;
              selections.homeRooms = roomsInfo;
            }
            if(bathsInfo){
              detailAdjustment += detailPricing.home.bathrooms[bathsInfo.value] || 0;
              selections.homeBathrooms = bathsInfo;
            }
            if(petsInfo){
              detailAdjustment += detailPricing.home.pets[petsInfo.value] || 0;
              selections.homePets = petsInfo;
            }
          }

          if(serviceKey === 'office'){
            const officesField = form.querySelector('input[name="office-offices"]');
            const officeBathsField = form.querySelector('input[name="office-bathrooms"]');

            const officesInfo = selectionInfo(officesField);
            const officeBathsInfo = selectionInfo(officeBathsField);

            if(officesInfo){
              detailAdjustment += detailPricing.office.offices[officesInfo.value] || 0;
              selections.officeOffices = officesInfo;
            }
            if(officeBathsInfo){
              detailAdjustment += detailPricing.office.bathrooms[officeBathsInfo.value] || 0;
              selections.officeBathrooms = officeBathsInfo;
            }
          }

          return {
            ready: true,
            base,
            detail: detailAdjustment,
            total: base + detailAdjustment,
            selections,
            serviceLabel: serviceInput?.dataset.label || serviceKey,
            sqftLabel: sqftInput?.dataset.label || sqftKey
          };
        }

        function formatCurrency(value){
          if(!value) return '‚Äî';
          return `$${Math.round(value)}`;
        }

        function updateTotals(){
          const totals = calculateTotals();

          if(basePriceEl){ basePriceEl.textContent = totals.ready ? formatCurrency(totals.base) : '‚Äî'; }
          if(totalPriceEl){ totalPriceEl.textContent = totals.ready ? formatCurrency(totals.total) : '‚Äî'; }

          if(detailRow && detailPriceEl){
            if(totals.ready && totals.detail > 0){
              detailRow.hidden = false;
              detailPriceEl.textContent = `+$${Math.round(totals.detail)}`;
            } else {
              detailRow.hidden = true;
              detailPriceEl.textContent = '‚Äî';
            }
          }

          const ready = totals.ready && hasAllRequired();
          form.classList.toggle('quote-ready', ready);
          if(seePriceBtn){ seePriceBtn.disabled = !ready; }

          return totals;
        }

        pillControls.forEach(control => {
          const targetName = control.dataset.targetInput;
          if(!targetName) return;
          const hiddenInput = form.querySelector(`input[name="${targetName}"]`);
          if(!hiddenInput) return;

          control.setAttribute('aria-pressed', 'false');

          control.addEventListener('click', () => {
            const group = control.closest('[role="radiogroup"]') || control.parentElement;
            if(group){
              Array.from(group.querySelectorAll('[data-target-input="' + targetName + '"]')).forEach(btn => {
                const active = btn === control;
                btn.classList.toggle('active', active);
                btn.setAttribute('aria-pressed', active ? 'true' : 'false');
              });
            }

            hiddenInput.value = control.dataset.value || '';
            hiddenInput.dataset.label = control.dataset.label || hiddenInput.value;
            hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
            updateServiceDetails(serviceInput ? serviceInput.value : '');
            updateTotals();
          });
        });

        requiredFields.forEach(field => {
          const eventName = field.tagName === 'SELECT' ? 'change' : 'input';
          field.addEventListener(eventName, updateTotals);
        });

        if(serviceInput){
          serviceInput.addEventListener('change', () => {
            updateServiceDetails(serviceInput.value);
            updateTotals();
          });
        }

        if(sqftInput){
          sqftInput.addEventListener('change', updateTotals);
        }

        if(seePriceBtn){
          seePriceBtn.addEventListener('click', () => {
            if(seePriceBtn.disabled) return;
            const totals = updateTotals();
            if(!totals.ready) return;

            const mode = form.dataset.quoteMode || 'redirect';
            if(mode !== 'redirect') return;

            const redirectTarget = form.dataset.redirect || 'book.html';
            const url = new URL(redirectTarget, window.location.origin);
            const params = url.searchParams;

            const serviceValue = serviceInput ? serviceInput.value : '';
            if(serviceValue){
              params.set('service', serviceValue);
              if(totals.serviceLabel){ params.set('serviceLabel', totals.serviceLabel); }
            }

            const sqftValue = sqftInput ? sqftInput.value : '';
            if(sqftValue){
              params.set('sqft', sqftValue);
              if(totals.sqftLabel){ params.set('sqftLabel', totals.sqftLabel); }
            }

            params.set('basePrice', totals.base.toFixed(2));
            params.set('detailPrice', totals.detail.toFixed(2));
            params.set('total', totals.total.toFixed(2));

            const firstName = form.querySelector('input[name="first-name"]');
            if(firstName && firstName.value.trim()){
              params.set('firstName', firstName.value.trim());
            }

            const email = form.querySelector('input[name="email"]');
            if(email && email.value.trim()){
              params.set('email', email.value.trim());
            }

            Object.entries(totals.selections || {}).forEach(([key, info]) => {
              if(info.value){ params.set(key, info.value); }
              if(info.label){ params.set(`${key}Label`, info.label); }
            });

            const anchor = form.dataset.redirectAnchor;
            const finalUrl = anchor ? `${url.toString()}#${anchor}` : url.toString();
            window.location.href = finalUrl;
          });
        }

        updateServiceDetails(serviceInput ? serviceInput.value : '');
        updateTotals();
      }
    })();
  </script>

  <script>
    (function(){
      const form = document.getElementById('bookingForm');
      if(!form) return;

      let steps = Array.from(form.querySelectorAll('.step'));
      let stepper = Array.from(document.getElementById('stepper').children || []);
      const reviewList = document.getElementById('reviewList');
      const successEl = document.getElementById('bookingSuccess');
      const layoutEl = document.getElementById('bookingLayout');

      const addonEmptyMessage = document.getElementById('addon-empty-message');

      const hiddenServiceKey = document.getElementById('input-service-key');
      const hiddenServiceLabel = document.getElementById('input-service-label');
      const hiddenSqftLabel = document.getElementById('input-sqft-label');
      const hiddenDetailSummary = document.getElementById('input-detail-summary');
      const hiddenBasePrice = document.getElementById('input-base-price');
      const hiddenDetailPrice = document.getElementById('input-detail-price');
      const hiddenAddonsPrice = document.getElementById('input-addons-price');
      const hiddenDiscountPrice = document.getElementById('input-discount-price');
      const hiddenTotalPrice = document.getElementById('input-total-price');
      const hiddenSelectedAddons = document.getElementById('input-selected-addons');
      const hiddenPackage = document.getElementById('input-package');
      const hiddenPayPalOrder = document.getElementById('input-paypal-order-id');
      const hiddenPayPalPayer = document.getElementById('input-paypal-payer-id');
      const hiddenPayPalCapture = document.getElementById('input-paypal-capture-id');
      const hiddenCartStatus = document.getElementById('input-cart-status');
      const CART_IMAGE_DATA_URI = (window.CART_IMAGE_DATA_URI && typeof window.CART_IMAGE_DATA_URI === 'string' && window.CART_IMAGE_DATA_URI.trim()) ? window.CART_IMAGE_DATA_URI : 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MDAiIGhlaWdodD0iNjAwIiB2aWV3Qm94PSIwIDAgNjAwIDYwMCI+ICA8ZGVmcz4KICAgIDxyYWRpYWxHcmFkaWVudCBpZD0iYmciIGN4PSI1MCUiIGN5PSI0NSUiIHI9IjY1JSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM3NDQ2ZmYiIHN0b3Atb3BhY2l0eT0iMC45NSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjU1JSIgc3RvcC1jb2xvcj0iIzVhMmFjNCIgc3RvcC1vcGFjaXR5PSIwLjkyIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzJkMTA1OCIgc3RvcC1vcGFjaXR5PSIwLjk4Ii8+CiAgICA8L3JhZGlhbEdyYWRpZW50PgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJnbG93IiB4MT0iMCIgeDI9IjAiIHkxPSIwIiB5Mj0iMSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmN2I1ZmYiIHN0b3Atb3BhY2l0eT0iMC45Ii8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iI2UxNmVmZiIgc3RvcC1vcGFjaXR5PSIwLjU1Ii8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJidWNrZXQiIHgxPSIwIiB4Mj0iMSIgeTE9IjAiIHkyPSIxIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzUyMmI4NSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IjZmMzViNiIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iaGFuZGxlIiB4MT0iMCIgeDI9IjAiIHkxPSIwIiB5Mj0iMSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNlZmU1ZmYiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjY2JkM2ZmIi8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogICAgPGxpbmVhckdyYWRpZW50IGlkPSJicm9vbSIgeDE9IjAiIHgyPSIxIiB5MT0iMCIgeTI9IjEiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjZjdkMjdjIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iI2ZiYjE0YSIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0idmFjIiB4MT0iMCIgeDI9IjAiIHkxPSIwIiB5Mj0iMSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiM0MjI1NjgiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjMmYxMzRiIi8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogICAgPGZpbHRlciBpZD0ic2hhZG93IiB4PSItMjAlIiB5PSItMjAlIiB3aWR0aD0iMTQwJSIgaGVpZ2h0PSIxNDAiPgogICAgICA8ZmVEcm9wU2hhZG93IGR4PSIwIiBkeT0iMTIiIHN0ZERldmlhdGlvbj0iMTgiIGZsb29kLWNvbG9yPSIjMTIwNjI2IiBmbG9vZC1vcGFjaXR5PSIwLjYiLz4KICAgIDwvZmlsdGVyPgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iNjAwIiBoZWlnaHQ9IjYwMCIgZmlsbD0idXJsKCNiZykiLz4KICA8ZWxsaXBzZSBjeD0iMzAwIiBjeT0iNDcwIiByeD0iMjIwIiByeT0iNzAiIGZpbGw9IiMxODA3MzAiIG9wYWNpdHk9IjAuNzUiLz4KICA8ZyBmaWx0ZXI9InVybCgjc2hhZG93KSI+CiAgICA8cGF0aCBkPSJNMTc0IDE3MGgyNTJhMTQgMTQgMCAwIDEgMTQgMTR2MzRhMTQgMTQgMCAwIDEtMTQgMTRIMTc0YTE0IDE0IDAgMCAxLTE0LTE0di0zNGExNCAxNCAwIDAgMSAxNC0xNHoiIGZpbGw9InVybCgjZ2xvdykiIG9wYWNpdHk9IjAuODUiLz4KICAgIDx0ZXh0IHg9IjMwMCIgeT0iMjA1IiBmb250LWZhbWlseT0iJ0JlYmFzIE5ldWUnLCAnQXJpYWwgQmxhY2snLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjMmQwZjQ3IiBsZXR0ZXItc3BhY2luZz0iNiI+ZHVmZmVyaW5kZWVwY2xlYW48L3RleHQ+CiAgPC9nPgogIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE1MCAyNDApIj4KICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE0MCAtMjApIj4KICAgICAgPHBhdGggZD0iTTExMCAwYzI4IDAgNTIgMjEgNTUgNDlsMTYgMTYyYzEgOS02IDE3LTE1IDE3SDU0Yy05IDAtMTYtOC0xNS0xN2wxNi0xNjJDNTggMjEgODIgMCAxMTAgMHoiIGZpbGw9InVybCgjYnVja2V0KSIvPgogICAgICA8cGF0aCBkPSJNNDYgNzZoMTI4bDcgNzBIMzl6IiBmaWxsPSIjN2M0OWQwIiBvcGFjaXR5PSIwLjQiLz4KICAgICAgPHBhdGggZD0iTTg4IC0zMmg0NGwyMCA3MEg2OHoiIGZpbGw9InVybCgjaGFuZGxlKSIvPgogICAgICA8cmVjdCB4PSI5MiIgeT0iLTUwIiB3aWR0aD0iMzYiIGhlaWdodD0iMjAiIHJ4PSIxMCIgZmlsbD0iI2ZlZjZmZiIgc3Ryb2tlPSIjY2JjOWZmIiBzdHJva2Utd2lkdGg9IjQiLz4KICAgIDwvZz4KICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQwIDIwKSI+CiAgICAgIDxwYXRoIGQ9Ik00NiAtNDBoMjRsMjQgMzIwaC0yNHoiIGZpbGw9IiNmOGU5ZmYiIHN0cm9rZT0iI2Q0YzBmZiIgc3Ryb2tlLXdpZHRoPSI2Ii8+CiAgICAgIDxwYXRoIGQ9Ik0tMTAgMjYwaDE2MGwxMiA1NGMyIDgtNCAxNi0xMiAxNkgtMzRjLTggMC0xNC04LTEyLTE2eiIgZmlsbD0idXJsKCNicm9vbSkiIHN0cm9rZT0iI2Y1OWQzMiIgc3Ryb2tlLXdpZHRoPSI2Ii8+CiAgICAgIDxwYXRoIGQ9Ik0tMjQgMjYwaDIwMCIgc3Ryb2tlPSIjZmFjYTY2IiBzdHJva2Utd2lkdGg9IjEyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIG9wYWNpdHk9IjAuNjUiLz4KICAgIDwvZz4KICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI2MCAxMCkiPgogICAgICA8cGF0aCBkPSJNMTIwIC0yMGMxNCAwIDI2IDEwIDI4IDI0bDI2IDI1MGMyIDE2LTEwIDMwLTI2IDMwSDY2Yy0xNiAwLTI4LTE0LTI2LTMwbDI2LTI1MGMyLTE0IDE0LTI0IDI4LTI0eiIgZmlsbD0idXJsKCN2YWMpIi8+CiAgICAgIDxwYXRoIGQ9Ik0xMDQgLTU0aDMybDEwIDM4aC01MnoiIGZpbGw9IiM1ZDJmOGYiLz4KICAgICAgPHJlY3QgeD0iOTIiIHk9Ii05NiIgd2lkdGg9IjU2IiBoZWlnaHQ9IjQ4IiByeD0iMjIiIGZpbGw9IiNmMGU3ZmYiIHN0cm9rZT0iI2QzYzlmZiIgc3Ryb2tlLXdpZHRoPSI2Ii8+CiAgICAgIDxyZWN0IHg9IjEyIiB5PSIyMzYiIHdpZHRoPSIyMDAiIGhlaWdodD0iNDIiIHJ4PSIxOCIgZmlsbD0iIzYyMzQ5YSIvPgogICAgPC9nPgogICAgPGcgb3BhY2l0eT0iMC43MiI+CiAgICAgIDxjaXJjbGUgY3g9IjIwNiIgY3k9IjI2IiByPSI4IiBmaWxsPSIjZmVmNmZmIi8+CiAgICAgIDxjaXJjbGUgY3g9IjIzNiIgY3k9Ii0xNiIgcj0iNiIgZmlsbD0iI2ZlZjZmZiIvPgogICAgICA8Y2lyY2xlIGN4PSIxNzYiIGN5PSItMTIiIHI9IjUiIGZpbGw9IiNmZWY2ZmYiLz4KICAgICAgPGNpcmNsZSBjeD0iMjQ2IiBjeT0iNTYiIHI9IjUiIGZpbGw9IiNmZWY2ZmYiLz4KICAgICAgPGNpcmNsZSBjeD0iMTE2IiBjeT0iMTYiIHI9IjYiIGZpbGw9IiNmZWY2ZmYiLz4KICAgIDwvZz4KICA8L2c+Cjwvc3ZnPg==';
      if(!window.CART_IMAGE_DATA_URI){
        window.CART_IMAGE_DATA_URI = CART_IMAGE_DATA_URI;
      }
      const resolveCartImagePath = () => {
        const candidates = [];
        if(window.CART_IMAGE_PATH && typeof window.CART_IMAGE_PATH === 'string'){
          candidates.push(window.CART_IMAGE_PATH);
        }
        if(document.body && document.body.dataset && typeof document.body.dataset.cartImage === 'string'){
          candidates.push(document.body.dataset.cartImage);
        }
        for(const candidate of candidates){
          if(candidate && typeof candidate === 'string' && candidate.trim()){
            return candidate.trim();
          }
        }
        return CART_IMAGE_DATA_URI;
      };
      const CART_IMAGE_PATH = resolveCartImagePath();
      if(!window.CART_IMAGE_PATH){
        window.CART_IMAGE_PATH = CART_IMAGE_PATH;
      }
      const cartImage = document.getElementById('cartSummaryImage');
      if(cartImage && !cartImage.getAttribute('src')){
        const fallback = CART_IMAGE_DATA_URI;
        const targetSrc = CART_IMAGE_PATH || fallback;
        const shouldListen = fallback && targetSrc !== fallback;
        const handleImageError = () => {
          cartImage.removeEventListener('error', handleImageError);
          cartImage.src = fallback;
        };
        if(shouldListen){
          cartImage.addEventListener('error', handleImageError);
        }
        cartImage.src = targetSrc;
      }
      const hiddenFullName = document.getElementById('input-full-name');
      const originField = document.getElementById('input-origin');

      const submitBtn = form.querySelector('.submit');

      const recapBase = document.querySelector('[data-recap-base]');
      const recapDetailRow = document.querySelector('[data-recap-detail-row]');
      const recapDetail = document.querySelector('[data-recap-detail]');
      const recapExtrasRow = document.querySelector('[data-recap-extras-row]');
      const recapExtras = document.querySelector('[data-recap-extras]');
      const recapDiscountRow = document.querySelector('[data-recap-discount-row]');
      const recapDiscount = document.querySelector('[data-recap-discount]');
      const recapTotal = document.querySelector('[data-recap-total]');
      const recapDescription = document.querySelector('[data-cart-description]');
      const cartService = document.querySelector('[data-cart-service]');
      const addToCartBtn = document.getElementById('addToCartBtn');
      const cartStatus = document.getElementById('cartStatus');
      const cartSummaryEl = document.getElementById('cartSummary');
      const summaryColumnEl = document.getElementById('summaryColumn');
      const cartSummaryTitle = document.querySelector('.cart-summary-title');
      const cartSummaryImage = document.getElementById('cartSummaryImage');
      const formColumnsEl = document.querySelector('.form-columns');
      const navCartButton = document.querySelector('[data-cart-toggle]');
      const navPayPalContainer = document.getElementById('nav-paypal-buttons');
      const navPayPalStatus = document.getElementById('nav-paypal-status');

      const cartScheduleEl = document.getElementById('cartSchedule');
      const cartScheduleFirst = document.querySelector('[data-cart-first-visit]');
      const cartScheduleNextRow = document.querySelector('[data-cart-next-row]');
      const cartScheduleNext = document.querySelector('[data-cart-next-visit]');
      const hiddenFirstVisit = document.getElementById('input-first-visit-date');
      const hiddenFollowUpVisit = document.getElementById('input-follow-up-date');
      const calendarSection = document.querySelector('[data-schedule-calendar]');
      const calendarGrid = calendarSection ? calendarSection.querySelector('[data-calendar-grid]') : null;
      const calendarMonthLabel = calendarSection ? calendarSection.querySelector('[data-calendar-month]') : null;
      const calendarPrevBtn = calendarSection ? calendarSection.querySelector('[data-calendar-prev]') : null;
      const calendarNextBtn = calendarSection ? calendarSection.querySelector('[data-calendar-next]') : null;
      const calendarSelectedDisplay = calendarSection ? calendarSection.querySelector('[data-calendar-selected]') : null;
      const calendarFollowUpRow = calendarSection ? calendarSection.querySelector('[data-calendar-follow-up-row]') : null;
      const calendarFollowUpDisplay = calendarSection ? calendarSection.querySelector('[data-calendar-follow-up]') : null;
      const calendarMessage = calendarSection ? calendarSection.querySelector('[data-calendar-message]') : null;
      const calendarError = document.getElementById('calendarError');

      const frequencyInputs = Array.from(form.querySelectorAll('input[name="frequency"]'));
      const addonGroups = Array.from(form.querySelectorAll('.addon-group'));
      const addonPills = Array.from(form.querySelectorAll('.addon-pill'));

      const escapeHtml = (value) => String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

      const MONTH_FORMATTER = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' });
      const DATE_FORMATTER = new Intl.DateTimeFormat('en-US', { weekday: 'short', month: 'long', day: 'numeric', year: 'numeric' });

      const todayStart = (() => {
        const base = new Date();
        base.setHours(0, 0, 0, 0);
        return base;
      })();

      let calendarCurrentMonth = new Date(todayStart.getFullYear(), todayStart.getMonth(), 1);
      let selectedVisitDate = null;
      let followUpVisitDate = null;

      function startOfDay(value){
        const date = new Date(value);
        date.setHours(0, 0, 0, 0);
        return date;
      }

      function formatDateLong(date){
        if(!(date instanceof Date) || Number.isNaN(date.getTime())) return '‚Äî';
        return DATE_FORMATTER.format(date);
      }

      function formatInputDate(date){
        if(!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function parseInputDate(value){
        if(!value) return null;
        const parsed = new Date(`${value}T00:00:00`);
        return Number.isNaN(parsed.getTime()) ? null : parsed;
      }

      function isSameDay(a, b){
        if(!(a instanceof Date) || !(b instanceof Date)) return false;
        return a.getFullYear() === b.getFullYear() &&
               a.getMonth() === b.getMonth() &&
               a.getDate() === b.getDate();
      }

      function formatDateHumanFromInput(value){
        const parsed = parseInputDate(value);
        return parsed ? formatDateLong(parsed) : '‚Äî';
      }

      function frequencyIntervalDays(){
        const freq = selectedFrequency();
        if(!freq) return null;
        switch(freq.value){
          case 'weekly': return 7;
          case 'biweekly': return 14;
          case 'triweekly': return 21;
          case 'monthly': return 30;
          case 'biannual': return 182;
          default: return null;
        }
      }

      function syncScheduleHidden(){
        if(hiddenFirstVisit){
          hiddenFirstVisit.value = selectedVisitDate ? formatInputDate(selectedVisitDate) : '';
        }
        if(hiddenFollowUpVisit){
          hiddenFollowUpVisit.value = followUpVisitDate ? formatInputDate(followUpVisitDate) : '';
        }
      }

      function syncCartSchedule(){
        if(!cartScheduleEl) return;
        if(selectedVisitDate){
          cartScheduleEl.hidden = false;
          cartScheduleEl.setAttribute('aria-hidden', 'false');
          if(cartScheduleFirst){
            cartScheduleFirst.textContent = formatDateLong(selectedVisitDate);
          }
          if(followUpVisitDate && cartScheduleNextRow){
            cartScheduleNextRow.hidden = false;
            cartScheduleNextRow.setAttribute('aria-hidden', 'false');
            if(cartScheduleNext){
              cartScheduleNext.textContent = formatDateLong(followUpVisitDate);
            }
          } else if(cartScheduleNextRow){
            cartScheduleNextRow.hidden = true;
            cartScheduleNextRow.setAttribute('aria-hidden', 'true');
          }
        } else {
          cartScheduleEl.hidden = true;
          cartScheduleEl.setAttribute('aria-hidden', 'true');
        }
      }

      function updateScheduleDisplays(){
        const interval = frequencyIntervalDays();
        if(selectedVisitDate && interval){
          const next = new Date(selectedVisitDate);
          next.setDate(next.getDate() + interval);
          followUpVisitDate = next;
        } else {
          followUpVisitDate = null;
        }

        if(calendarSelectedDisplay){
          calendarSelectedDisplay.textContent = selectedVisitDate ? formatDateLong(selectedVisitDate) : '‚Äî';
        }
        if(calendarFollowUpRow && calendarFollowUpDisplay){
          if(followUpVisitDate){
            calendarFollowUpRow.hidden = false;
            calendarFollowUpDisplay.textContent = formatDateLong(followUpVisitDate);
          } else {
            calendarFollowUpRow.hidden = true;
            calendarFollowUpDisplay.textContent = '‚Äî';
          }
        }
        if(calendarMessage){
          const freq = selectedFrequency();
          if(selectedVisitDate && followUpVisitDate){
            const label = freq ? (freq.closest('.plan')?.querySelector('.plan-title')?.textContent || freq.value) : '';
            calendarMessage.textContent = label ? `${label.trim()} schedule locked in.` : 'Recurring schedule locked in.';
          } else if(selectedVisitDate){
            if(freq && freq.value === 'onetime'){
              calendarMessage.textContent = 'One-time visit selected ‚Äî add any finishing touches you‚Äôd like.';
            } else {
              calendarMessage.textContent = 'Choose a visit frequency above to preview your follow-up date.';
            }
          } else {
            calendarMessage.textContent = 'Pick your starting date to preview your recurring visits.';
          }
        }
        if(calendarError && selectedVisitDate){
          calendarError.hidden = true;
        }

        syncScheduleHidden();
        syncCartSchedule();
      }

      function renderCalendar(){
        if(!calendarSection || !calendarGrid) return;
        const monthDate = new Date(calendarCurrentMonth);
        monthDate.setDate(1);
        if(calendarMonthLabel){
          calendarMonthLabel.textContent = MONTH_FORMATTER.format(monthDate);
        }

        if(calendarPrevBtn){
          const prevMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() - 1, 1);
          const canGoPrev = canNavigateToMonth(prevMonth);
          calendarPrevBtn.disabled = !canGoPrev;
          calendarPrevBtn.setAttribute('aria-disabled', canGoPrev ? 'false' : 'true');
        }
        if(calendarNextBtn){
          calendarNextBtn.disabled = false;
          calendarNextBtn.setAttribute('aria-disabled', 'false');
        }

        calendarGrid.innerHTML = '';
        const startDay = monthDate.getDay();
        const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
        const frag = document.createDocumentFragment();

        for(let i = 0; i < startDay; i++){
          const spacer = document.createElement('div');
          spacer.className = 'calendar-cell calendar-cell--empty';
          frag.appendChild(spacer);
        }

        for(let day = 1; day <= daysInMonth; day++){
          const cellDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), day);
          cellDate.setHours(0, 0, 0, 0);
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'calendar-day';
          button.textContent = String(day);
          button.dataset.date = formatInputDate(cellDate);
          button.setAttribute('aria-label', cellDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }));

          if(cellDate < todayStart){
            button.disabled = true;
            button.classList.add('is-disabled');
          }

          if(selectedVisitDate && isSameDay(cellDate, selectedVisitDate)){
            button.classList.add('is-selected');
          }

          if(followUpVisitDate && isSameDay(cellDate, followUpVisitDate)){
            button.classList.add('is-followup');
          }

          button.addEventListener('click', () => {
            if(button.disabled) return;
            selectedVisitDate = new Date(cellDate);
            calendarCurrentMonth = new Date(selectedVisitDate.getFullYear(), selectedVisitDate.getMonth(), 1);
            updateScheduleDisplays();
            renderCalendar();
          });

          const cell = document.createElement('div');
          cell.className = 'calendar-cell';
          cell.appendChild(button);
          frag.appendChild(cell);
        }

        const totalCells = startDay + daysInMonth;
        const trailing = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for(let i = 0; i < trailing; i++){
          const spacer = document.createElement('div');
          spacer.className = 'calendar-cell calendar-cell--empty';
          frag.appendChild(spacer);
        }

        calendarGrid.appendChild(frag);
      }

      function canNavigateToMonth(target){
        if(!(target instanceof Date)) return false;
        const minMonth = new Date(todayStart.getFullYear(), todayStart.getMonth(), 1);
        return target.getTime() >= minMonth.getTime();
      }

      if(calendarPrevBtn){
        calendarPrevBtn.addEventListener('click', () => {
          const prev = new Date(calendarCurrentMonth);
          prev.setMonth(prev.getMonth() - 1);
          if(!canNavigateToMonth(prev)) return;
          calendarCurrentMonth = prev;
          renderCalendar();
        });
      }

      if(calendarNextBtn){
        calendarNextBtn.addEventListener('click', () => {
          const next = new Date(calendarCurrentMonth);
          next.setMonth(next.getMonth() + 1);
          calendarCurrentMonth = next;
          renderCalendar();
        });
      }

      if(hiddenFirstVisit && hiddenFirstVisit.value){
        const parsed = parseInputDate(hiddenFirstVisit.value);
        if(parsed){
          selectedVisitDate = startOfDay(parsed);
        }
      }

      if(hiddenFollowUpVisit && hiddenFollowUpVisit.value){
        const parsedNext = parseInputDate(hiddenFollowUpVisit.value);
        if(parsedNext){
          followUpVisitDate = startOfDay(parsedNext);
        }
      }

      if(selectedVisitDate){
        calendarCurrentMonth = new Date(selectedVisitDate.getFullYear(), selectedVisitDate.getMonth(), 1);
      }

      if(calendarSection && calendarGrid){
        updateScheduleDisplays();
        renderCalendar();
      }

      const ADDON_ICON_SVGS = {
        sparkle: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><path d="M16 5l2.2 5.8 6 .4-4.7 4 1.4 5.7-4.9-3.1-4.9 3.1 1.4-5.7-4.7-4 6-.4z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M9.2 9.5l1.1 2.3 2.5.2-2 1.7.6 2.3-2.1-1.3-2.1 1.3.6-2.3-2-1.7 2.5-.2z" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" opacity=".6"/></svg>`,
        truck: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><path d="M5 12h12v9H7a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M17 12h5l3 4v5h-4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><circle cx="11.5" cy="23" r="2.4" fill="none" stroke="currentColor" stroke-width="1.6"/><circle cx="23.5" cy="23" r="2.4" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M9 12V8.5A2.5 2.5 0 0 1 11.5 6H15" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
        tool: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><path d="M19 6.5a4 4 0 0 0-5.4 5.4l-6.1 6.1 2.3 2.3 6.1-6.1a4 4 0 0 0 5.4-5.4l3.7-3.2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M13.8 14.2l7.5 7.5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><circle cx="23.5" cy="8.5" r="2.5" fill="none" stroke="currentColor" stroke-width="1.6"/></svg>`,
        cap: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><path d="M4 12l12-5 12 5-12 5-12-5z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M10 16v4.5c0 2.2 2.7 3.5 6 3.5s6-1.3 6-3.5V16" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M26 13.5v7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
        home: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><path d="M6 14l10-8 10 8v12H6V14z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M13 26v-7h6v7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>`,
        paw: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><circle cx="10" cy="12" r="2.2" fill="none" stroke="currentColor" stroke-width="1.4"/><circle cx="16" cy="10" r="2.4" fill="none" stroke="currentColor" stroke-width="1.4"/><circle cx="22" cy="12" r="2.2" fill="none" stroke="currentColor" stroke-width="1.4"/><path d="M11 19c0-3 2.7-5 5-5s5 2 5 5-2.2 6-5 6-5-3-5-6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>`,
        fridge: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><rect x="9" y="5" width="14" height="22" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.6"/><line x1="9" y1="15" x2="23" y2="15" stroke="currentColor" stroke-width="1.6"/><line x1="12.5" y1="11" x2="12.5" y2="13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
        oven: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><rect x="7" y="7" width="18" height="20" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.6"/><rect x="10" y="13" width="12" height="9" rx="1.5" fill="none" stroke="currentColor" stroke-width="1.6"/><circle cx="11" cy="10" r="1" fill="currentColor"/><circle cx="16" cy="10" r="1" fill="currentColor"/><circle cx="21" cy="10" r="1" fill="currentColor"/></svg>`,
        cabinet: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><rect x="8" y="7" width="16" height="18" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.6"/><line x1="8" y1="15" x2="24" y2="15" stroke="currentColor" stroke-width="1.6"/><line x1="8" y1="21" x2="24" y2="21" stroke="currentColor" stroke-width="1.6"/><circle cx="16" cy="12" r="0.9" fill="currentColor"/><circle cx="16" cy="18" r="0.9" fill="currentColor"/><circle cx="16" cy="24" r="0.9" fill="currentColor"/></svg>`,
        utensils: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><path d="M10 5v8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M8 5v4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M12 5v4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M21 13v14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M8 13v14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M12 13v14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M18 5a3 3 0 0 1 3 3v5.5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
        blinds: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><rect x="7" y="7" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.6"/><line x1="9" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><line x1="9" y1="16" x2="23" y2="16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><line x1="9" y1="20" x2="23" y2="20" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M16 25v3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
        window: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><rect x="7" y="7" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.6"/><line x1="16" y1="7" x2="16" y2="25" stroke="currentColor" stroke-width="1.6"/><line x1="7" y1="16" x2="25" y2="16" stroke="currentColor" stroke-width="1.6"/></svg>`,
        bed: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><path d="M7 14h18a3 3 0 0 1 3 3v9H4v-9a3 3 0 0 1 3-3z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M10 14V9a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>`,
        dish: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><circle cx="16" cy="16" r="9" fill="none" stroke="currentColor" stroke-width="1.6"/><circle cx="16" cy="16" r="4" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M24 6v5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
        spray: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><path d="M13 6h6l2 3h-6l-2-3z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M14 9h8l-2 4v11a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2V13l2-4z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><circle cx="23" cy="7" r="1.2" fill="currentColor"/><circle cx="25.5" cy="7.5" r="0.9" fill="currentColor" opacity=".6"/></svg>`,
        vacuum: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><path d="M18 10l4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M18 22V10a3 3 0 0 0-3-3h-3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M10 24a6 6 0 0 1 12 0" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M16 24v4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M12 24H8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M20 24h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
        tiles: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><rect x="7" y="7" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6"/><line x1="13" y1="7" x2="13" y2="25" stroke="currentColor" stroke-width="1.6"/><line x1="19" y1="7" x2="19" y2="25" stroke="currentColor" stroke-width="1.6"/><line x1="7" y1="13" x2="25" y2="13" stroke="currentColor" stroke-width="1.6"/><line x1="7" y1="19" x2="25" y2="19" stroke="currentColor" stroke-width="1.6"/></svg>`,
        squeegee: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><path d="M7 10h18l-2 6H9l-2-6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M16 16v10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M13 26h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
        pressure: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><path d="M8 20h9a3 3 0 0 1 3 3v4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M14 20V10l4-2 2 3v4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M22 9l4-2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M22 11l4 1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M21 13l3.5 2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" opacity=".7"/></svg>`,
        floor: `<svg viewBox="0 0 32 32" aria-hidden="true" focusable="false"><circle cx="16" cy="22" r="6" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M16 22l6-14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M20 6h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M21 9h3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`
      };

      addonPills.forEach(pill => {
        const iconSpan = pill.querySelector('.addon-icon[data-icon]');
        if(iconSpan){
          const key = iconSpan.dataset.icon || '';
          if(ADDON_ICON_SVGS[key]){
            iconSpan.innerHTML = ADDON_ICON_SVGS[key];
          }
        }
      });
      const paymentRadios = Array.from(form.querySelectorAll('input[name="payment_method"]'));
      const paypalUi = document.querySelector('[data-payment-ui="paypal"]');
      const stripeUi = document.querySelector('[data-payment-ui="stripe"]');
      const stripeCheckoutBtn = document.getElementById('stripe-checkout-btn');
      const stripeStatus = document.getElementById('stripe-status');
      const stripeReferenceInput = document.getElementById('stripe-reference-input');
      const searchParams = new URLSearchParams(window.location.search);
      const stripeSessionId = searchParams.get('session_id');
      const stripeSuccess = searchParams.get('stripe_success') === '1';
      const paypalButtonsContainer = document.getElementById('paypal-buttons');
      const paypalStatus = document.getElementById('paypal-status');
      const PAYPAL_CONTEXTS = {};
      if(paypalButtonsContainer){
        PAYPAL_CONTEXTS.main = { container: paypalButtonsContainer, status: paypalStatus };
      }
      if(navPayPalContainer){
        PAYPAL_CONTEXTS.nav = { container: navPayPalContainer, status: navPayPalStatus };
      }

      const PAYPAL_CURRENCY = ((document.body && document.body.dataset && document.body.dataset.paypalCurrency) || 'CAD').toUpperCase();
      const FREQUENCY_LABELS = {
        weekly: 'Weekly (25% off)',
        biweekly: 'Bi-Weekly (20% off)',
        triweekly: 'Tri-Weekly (15% off)',
        monthly: 'Monthly (10% off)',
        biannual: 'Biannual (5% off)',
        onetime: 'One-time'
      };

      const paypalButtonsInstances = {};
      let paypalApproved = false;
      let paypalApprovedAmount = 0;
      let paypalScriptPromise = null;

      if(stripeReferenceInput && stripeSessionId){
        stripeReferenceInput.value = stripeSessionId;
      }
      if(stripeSuccess){
        setStripeStatus('Stripe payment confirmed. Your checkout session ID has been added ‚Äî submit your booking now.');
      }
      let current = 0;
      let cartAdded = false;
      let autoAddAfterSkip = false;
      let lastCartSignature = '';
      let latestCartState = null;
      let quoteAvailable = false;

      const params = new URLSearchParams(window.location.search);
      const DEFAULT_SERVICE_LABEL = 'House Cleaning Package';
      const SERVICE_LABELS = {
        home: 'House Cleaning Package',
        commercial: 'Commercial Cleaning Package',
        office: 'Office Cleaning Package'
      };

      const BASE_PRICE_TABLE = {
        home: {
          '1000-1500': 165,
          '1500-2000': 185,
          '2000-2500': 215,
          '2500-3000': 245,
          '3000-3500': 285,
          '3500-4000': 325,
          '4000-4500': 345,
          '4500-5000': 365,
          '5000-5500': 385,
          '5500-6000': 405,
          '6000-6500': 425,
          '6500-7000': 445,
          '7000-7500': 465,
          '7500-8000': 485,
          '8000-8500': 505,
          '8500-9000': 525,
          '9000-9500': 545,
          '9500-10000': 565,
          '10000-10500': 585,
          '10500-11000': 605,
          '11000-11500': 625,
          '11500-12000': 645,
          '12000-12500': 665,
          '12500-13000': 685,
          '13000-13500': 705,
          '13500-14000': 725,
          '14000-14500': 745,
          '14500-15000': 765,
          '15000-15500': 785,
          '15500-16000': 805,
          '16000-16500': 825,
          '16500-17000': 845,
          '17000-17500': 865,
          '17500-18000': 885,
          '18000-18500': 905,
          '18500-19000': 925,
          '19000-19500': 945,
          '19500-20000': 965
        },
        commercial: {
          '1000-1500': 240,
          '1500-2000': 285,
          '2000-2500': 330,
          '2500-3000': 380,
          '3000-3500': 425,
          '3500-4000': 470,
          '4000-4500': 495,
          '4500-5000': 520,
          '5000-5500': 545,
          '5500-6000': 570,
          '6000-6500': 595,
          '6500-7000': 620,
          '7000-7500': 645,
          '7500-8000': 670,
          '8000-8500': 695,
          '8500-9000': 720,
          '9000-9500': 745,
          '9500-10000': 770,
          '10000-10500': 795,
          '10500-11000': 820,
          '11000-11500': 845,
          '11500-12000': 870,
          '12000-12500': 895,
          '12500-13000': 920,
          '13000-13500': 945,
          '13500-14000': 970,
          '14000-14500': 995,
          '14500-15000': 1020,
          '15000-15500': 1045,
          '15500-16000': 1070,
          '16000-16500': 1095,
          '16500-17000': 1120,
          '17000-17500': 1145,
          '17500-18000': 1170,
          '18000-18500': 1195,
          '18500-19000': 1220,
          '19000-19500': 1245,
          '19500-20000': 1270
        },
        office: {
          '1000-1500': 210,
          '1500-2000': 250,
          '2000-2500': 295,
          '2500-3000': 335,
          '3000-3500': 375,
          '3500-4000': 420,
          '4000-4500': 442,
          '4500-5000': 464,
          '5000-5500': 486,
          '5500-6000': 508,
          '6000-6500': 530,
          '6500-7000': 552,
          '7000-7500': 574,
          '7500-8000': 596,
          '8000-8500': 618,
          '8500-9000': 640,
          '9000-9500': 662,
          '9500-10000': 684,
          '10000-10500': 706,
          '10500-11000': 728,
          '11000-11500': 750,
          '11500-12000': 772,
          '12000-12500': 794,
          '12500-13000': 816,
          '13000-13500': 838,
          '13500-14000': 860,
          '14000-14500': 882,
          '14500-15000': 904,
          '15000-15500': 926,
          '15500-16000': 948,
          '16000-16500': 970,
          '16500-17000': 992,
          '17000-17500': 1014,
          '17500-18000': 1036,
          '18000-18500': 1058,
          '18500-19000': 1080,
          '19000-19500': 1102,
          '19500-20000': 1124
        }
      };
      const DETAIL_PRICE_TABLE = {
        home: {
          rooms: { '1-2': 0, '3-4': 25, '5-6': 55, '7+': 85 },
          bathrooms: { '1': 0, '2': 18, '3': 36, '4+': 54 },
          pets: { no: 0, yes: 25 },
          basement: { no: 0, yes: 45 },
          basementRooms: { '1-2': 25, '3-4': 45, '5+': 65 },
          basementBathrooms: { '1': 18, '2': 32, '3+': 46 }
        },
        office: {
          offices: { '1-5': 0, '6-10': 45, '11-20': 90, '21+': 135 },
          bathrooms: { '1-2': 0, '3-4': 40, '5+': 70 }
        }
      };

      const serviceKey = params.get('service') || '';
      const rawServiceLabel = params.get('serviceLabel') || '';
      const sqftKey = params.get('sqft') || '';
      const rawSqftLabel = params.get('sqftLabel') || '';
      let basePrice = Number(params.get('basePrice') || params.get('total') || 0);
      let detailPrice = Number(params.get('detailPrice') || 0);
      const totalParam = Number(params.get('total') || 0);
      let totalBase = 0;

      const showOptionalServices = serviceKey === 'home';
      const optionalStep = form.querySelector('[data-step-optional]');
      const optionalStepperItem = document.querySelector('[data-stepper-optional]');
      if(!showOptionalServices){
        if(optionalStep){ optionalStep.remove(); }
        if(optionalStepperItem){ optionalStepperItem.remove(); }
      }

      steps = Array.from(form.querySelectorAll('.step'));
      stepper = Array.from(document.getElementById('stepper').children || []);
      stepper.forEach((item, idx) => {
        if(item.dataset.stepperLabel){
          item.textContent = `${idx + 1}. ${item.dataset.stepperLabel}`;
        }
        item.dataset.stepIndex = String(idx);
        item.setAttribute('role', 'button');
        item.tabIndex = idx === 0 ? 0 : -1;
        item.setAttribute('aria-disabled', idx === 0 ? 'false' : 'true');
        item.addEventListener('click', () => {
          if(idx <= current){
            showStep(idx);
          }
        });
        item.addEventListener('keydown', (event) => {
          if((event.key === 'Enter' || event.key === ' ') && idx <= current){
            event.preventDefault();
            showStep(idx);
          }
        });
      });

      function formatSqftLabel(label, key){
        if(label) return label;
        if(!key) return '';
        if(key.includes('-')){
          const parts = key.split('-').map(part => parseInt(part, 10));
          if(parts.length === 2 && parts.every(num => !Number.isNaN(num))){
            return `${parts[0].toLocaleString()} ‚Äì ${parts[1].toLocaleString()} sq ft`;
          }
        }
        return key;
      }

      function deriveDetailPrice(service){
        if(service === 'home'){
          let total = 0;
          const rooms = Number(params.get('homeRooms') || 0);
          if(rooms){
            if(rooms <= 2){ total += DETAIL_PRICE_TABLE.home.rooms['1-2'] || 0; }
            else if(rooms <= 4){ total += DETAIL_PRICE_TABLE.home.rooms['3-4'] || 0; }
            else if(rooms <= 6){ total += DETAIL_PRICE_TABLE.home.rooms['5-6'] || 0; }
            else { total += DETAIL_PRICE_TABLE.home.rooms['7+'] || 0; }
          }
          const baths = Number(params.get('homeBathrooms') || 0);
          if(baths){
            if(baths <= 1){ total += DETAIL_PRICE_TABLE.home.bathrooms['1'] || 0; }
            else if(baths <= 2){ total += DETAIL_PRICE_TABLE.home.bathrooms['2'] || 0; }
            else if(baths <= 3){ total += DETAIL_PRICE_TABLE.home.bathrooms['3'] || 0; }
            else { total += DETAIL_PRICE_TABLE.home.bathrooms['4+'] || 0; }
          }
          const pets = params.get('homePets');
          if(pets && Object.prototype.hasOwnProperty.call(DETAIL_PRICE_TABLE.home.pets, pets)){
            total += DETAIL_PRICE_TABLE.home.pets[pets] || 0;
          }
          const basement = params.get('homeBasement');
          if(basement && Object.prototype.hasOwnProperty.call(DETAIL_PRICE_TABLE.home.basement, basement)){
            total += DETAIL_PRICE_TABLE.home.basement[basement] || 0;
            if(basement === 'yes'){
              const basementRooms = Number(params.get('homeBasementRooms') || 0);
              if(basementRooms){
                if(basementRooms <= 2){ total += DETAIL_PRICE_TABLE.home.basementRooms['1-2'] || 0; }
                else if(basementRooms <= 4){ total += DETAIL_PRICE_TABLE.home.basementRooms['3-4'] || 0; }
                else { total += DETAIL_PRICE_TABLE.home.basementRooms['5+'] || 0; }
              }
              const basementBaths = Number(params.get('homeBasementBathrooms') || 0);
              if(basementBaths){
                if(basementBaths <= 1){ total += DETAIL_PRICE_TABLE.home.basementBathrooms['1'] || 0; }
                else if(basementBaths <= 2){ total += DETAIL_PRICE_TABLE.home.basementBathrooms['2'] || 0; }
                else { total += DETAIL_PRICE_TABLE.home.basementBathrooms['3+'] || 0; }
              }
            }
          }
          return total;
        }
        if(service === 'office'){
          let total = 0;
          const officesValue = params.get('officeOffices');
          if(officesValue){
            const officesKey = DETAIL_PRICE_TABLE.office.offices[officesValue] !== undefined
              ? officesValue
              : (() => {
                  const count = Number(officesValue);
                  if(!(count > 0)) return '';
                  if(count <= 5) return '1-5';
                  if(count <= 10) return '6-10';
                  if(count <= 20) return '11-20';
                  return '21+';
                })();
            if(officesKey && DETAIL_PRICE_TABLE.office.offices[officesKey] !== undefined){
              total += DETAIL_PRICE_TABLE.office.offices[officesKey] || 0;
            }
          }
          const officeBathsValue = params.get('officeBathrooms');
          if(officeBathsValue){
            const bathsKey = DETAIL_PRICE_TABLE.office.bathrooms[officeBathsValue] !== undefined
              ? officeBathsValue
              : (() => {
                  const count = Number(officeBathsValue);
                  if(!(count > 0)) return '';
                  if(count <= 2) return '1-2';
                  if(count <= 4) return '3-4';
                  return '5+';
                })();
            if(bathsKey && DETAIL_PRICE_TABLE.office.bathrooms[bathsKey] !== undefined){
              total += DETAIL_PRICE_TABLE.office.bathrooms[bathsKey] || 0;
            }
          }
          return total;
        }
        return 0;
      }

      if(!(detailPrice > 0)){
        const derivedDetail = deriveDetailPrice(serviceKey);
        if(derivedDetail > 0){
          detailPrice = derivedDetail;
        }
      }

      if(!(basePrice > 0) && totalParam > 0){
        const possibleBase = totalParam - detailPrice;
        if(possibleBase > 0){
          basePrice = possibleBase;
        }
      }

      if(!(basePrice > 0) && serviceKey && sqftKey && BASE_PRICE_TABLE[serviceKey] && BASE_PRICE_TABLE[serviceKey][sqftKey]){
        basePrice = BASE_PRICE_TABLE[serviceKey][sqftKey];
      }

      totalBase = basePrice + detailPrice;
      if(totalParam > 0 && totalBase < totalParam){
        totalBase = totalParam;
        if(!(basePrice > 0)){
          const inferredBase = totalBase - detailPrice;
          basePrice = inferredBase > 0 ? inferredBase : totalBase;
        }
      }

      quoteAvailable = totalBase > 0;
      if(cartSummaryEl){
        cartSummaryEl.classList.toggle('cart-summary-empty', !quoteAvailable);
      }

      const resolvedServiceLabel = rawServiceLabel || SERVICE_LABELS[serviceKey] || DEFAULT_SERVICE_LABEL;
      const resolvedSqftLabel = formatSqftLabel(rawSqftLabel, sqftKey);
      const hasServiceSelection = !!(serviceKey || rawServiceLabel);

      if(cartSummaryTitle){
        cartSummaryTitle.textContent = resolvedServiceLabel;
      }
      if(cartSummaryImage){
        cartSummaryImage.alt = `${resolvedServiceLabel} preview`;
      }

      const detailSelections = [];
      function pushDetail(label, value){
        if(value){ detailSelections.push(label + ': ' + value); }
      }
      pushDetail('Service', resolvedServiceLabel || serviceKey);
      pushDetail('Square Footage', resolvedSqftLabel || sqftKey);
      pushDetail('Rooms', params.get('homeRoomsLabel'));
      pushDetail('Bathrooms', params.get('homeBathroomsLabel'));
      pushDetail('Pets', params.get('homePetsLabel'));
      pushDetail('Basement', params.get('homeBasementLabel'));
      pushDetail('Basement Rooms', params.get('homeBasementRoomsLabel'));
      pushDetail('Basement Bathrooms', params.get('homeBasementBathroomsLabel'));
      pushDetail('Offices', params.get('officeOfficesLabel'));
      pushDetail('Office Bathrooms', params.get('officeBathroomsLabel'));

      hiddenServiceKey.value = serviceKey;
      hiddenServiceLabel.value = resolvedServiceLabel;
      hiddenSqftLabel.value = resolvedSqftLabel;
      const detailSummaryLines = detailSelections.slice();
      const detailSummaryValue = detailSummaryLines.join(' | ');
      const detailSummaryDisplay = detailSummaryLines.length
        ? detailSummaryLines.join(' ‚Ä¢ ')
        : (totalBase > 0 ? 'Base package from instant quote.' : '');
      hiddenDetailSummary.value = detailSummaryValue || (totalBase > 0 ? 'Base package from instant quote.' : '');
      hiddenBasePrice.value = quoteAvailable ? basePrice.toFixed(2) : '';
      hiddenDetailPrice.value = quoteAvailable ? detailPrice.toFixed(2) : '';
      hiddenPackage.value = resolvedServiceLabel;

      function renderCartDescription(extraItems = []){
        if(!recapDescription) return;
        const lines = detailSummaryLines.slice();
        if(extraItems.length){
          const extrasLine = `Add-ons: ${extraItems.map(item => `${item.name} √ó${item.qty}`).join(', ')}`;
          lines.push(extrasLine);
        }
        if(lines.length){
          recapDescription.hidden = false;
          recapDescription.innerHTML = lines
            .map(line => `<span class="cart-detail-line">${escapeHtml(line)}</span>`)
            .join('');
        } else {
          recapDescription.hidden = true;
          recapDescription.innerHTML = '';
        }
      }

      renderCartDescription();

      if(cartService){
        cartService.textContent = quoteAvailable
          ? resolvedServiceLabel
          : 'Select a package on the quote page to see pricing here.';
      }

      if(cartStatus && !quoteAvailable){
        cartStatus.classList.remove('error');
        cartStatus.textContent = 'Select a package on the quote page to see pricing here.';
      } else if(cartStatus && cartStatus.textContent === 'Select a package on the quote page to see pricing here.'){
        cartStatus.textContent = '';
      }

      if(originField){
        originField.value = serviceKey ? 'instant-quote' : 'book-page';
      }

      const sqftInput = form.querySelector('input[name="sqft"]');
      if(sqftInput && sqftKey){
        const avg = (() => {
          if(sqftKey.includes('-')){
            const parts = sqftKey.split('-').map(p => parseInt(p, 10));
            if(parts.length === 2 && parts.every(n => !Number.isNaN(n))){
              return Math.round((parts[0] + parts[1]) / 2);
            }
          }
          return '';
        })();
        if(avg) sqftInput.value = avg;
      }

      const firstNameField = form.querySelector('input[name="first_name"]');
      const lastNameField = form.querySelector('input[name="last_name"]');
      const emailField = form.querySelector('input[name="email"]');
      const quoteFirst = params.get('firstName') || '';
      const quoteLast = params.get('lastName') || '';
      const quoteFull = params.get('fullName') || '';
      const quoteEmail = params.get('email');
      if(firstNameField){
        if(quoteFirst){
          firstNameField.value = quoteFirst.trim();
        } else if(quoteFull){
          firstNameField.value = quoteFull.trim().split(/\s+/)[0] || '';
        }
      }
      if(lastNameField){
        if(quoteLast){
          lastNameField.value = quoteLast.trim();
        } else if(quoteFull){
          const parts = quoteFull.trim().split(/\s+/);
          if(parts.length > 1){ lastNameField.value = parts.slice(1).join(' '); }
        }
      }
      if(emailField && quoteEmail) emailField.value = quoteEmail.trim();

      function syncFullName(){
        if(!hiddenFullName) return;
        const first = firstNameField ? firstNameField.value.trim() : '';
        const last = lastNameField ? lastNameField.value.trim() : '';
        hiddenFullName.value = [first, last].filter(Boolean).join(' ');
      }
      syncFullName();
      if(firstNameField) firstNameField.addEventListener('input', syncFullName);
      if(lastNameField) lastNameField.addEventListener('input', syncFullName);

      function formatCurrency(value){
        if(!value) return '‚Äî';
        return `$${Math.round(value).toString()}`;
      }

      function updateAddonVisibility(){
        let visibleGroups = 0;
        addonGroups.forEach(group => {
          const services = (group.dataset.serviceGroup || '').split(',');
          const active = serviceKey && services.includes(serviceKey);
          group.classList.toggle('active', active);
          if(active) visibleGroups += 1;
        });
        if(addonEmptyMessage){ addonEmptyMessage.hidden = visibleGroups !== 0; }
      }
      updateAddonVisibility();

      function dispatchNavCartUpdate(justAdded){
        if(typeof window.updateNavCartPopover !== 'function') return;
        if(!latestCartState){
          window.updateNavCartPopover(null);
          return;
        }
        const snapshot = Object.assign({}, latestCartState);
        if(justAdded){ snapshot.justAdded = true; }
        window.updateNavCartPopover(snapshot);
      }

      function triggerCartFlight(){
        if(!cartSummaryEl || !navCartButton || !quoteAvailable) return;
        const start = cartSummaryEl.getBoundingClientRect();
        const end = navCartButton.getBoundingClientRect();
        if(!start.width || !end.width) return;

        const flight = document.createElement('div');
        flight.className = 'cart-flight';
        const img = document.createElement('img');
        const preview = cartSummaryEl.querySelector('img');
        img.src = (preview && preview.src) ? preview.src : CART_IMAGE_DATA_URI;
        img.alt = '';
        img.setAttribute('aria-hidden', 'true');
        flight.appendChild(img);

        const size = Math.max(Math.min(start.width, 140), 76);
        flight.style.width = `${size}px`;
        flight.style.height = `${size}px`;
        flight.style.left = `${start.left + (start.width / 2) - (size / 2)}px`;
        flight.style.top = `${start.top + (start.height / 2) - (size / 2)}px`;

        document.body.appendChild(flight);

        const deltaX = end.left + end.width / 2 - (start.left + start.width / 2);
        const deltaY = end.top + end.height / 2 - (start.top + start.height / 2);

        flight.style.opacity = '1';
        const animation = flight.animate([
          { transform: 'translate3d(0,0,0) scale(1)', opacity: 1 },
          { transform: `translate3d(${deltaX}px, ${deltaY}px, 0) scale(0.35)`, opacity: 0 }
        ], {
          duration: 720,
          easing: 'cubic-bezier(0.2, 0.75, 0.12, 1)'
        });

        animation.onfinish = () => flight.remove();
        animation.oncancel = () => flight.remove();

        cartSummaryEl.classList.add('cart-summary-flight');
        window.setTimeout(() => {
          cartSummaryEl.classList.remove('cart-summary-flight');
        }, 640);
      }

      function ensureCartAdded(options){
        if(cartAdded || !quoteAvailable) return;
        const freqInput = selectedFrequency();
        if(!freqInput) return;
        cartAdded = true;
        refreshCartButton();
        if(cartStatus){
          cartStatus.classList.remove('error');
          cartStatus.textContent = 'Package added to your cart. Continue through the steps to finalize.';
        }
        if(options && options.animate){
          triggerCartFlight();
        }
        updateSummary();
        dispatchNavCartUpdate(true);
      }

      const extrasState = [];
      function computeExtras(){
        extrasState.length = 0;
        addonPills.forEach(pill => {
          const parent = pill.closest('.addon-group');
          if(!parent || !parent.classList.contains('active')) return;
          if(!pill.classList.contains('active')) return;
          const qty = 1;
          const price = Number(pill.dataset.price || 0);
          const name = pill.querySelector('.addon-name')?.textContent.trim() || pill.dataset.addon || 'Addon';
          extrasState.push({ name, qty, price });
        });
        return extrasState;
      }

      function clearExtras(){
        addonPills.forEach(pill => {
          pill.classList.remove('active');
          pill.setAttribute('aria-pressed', 'false');
        });
        updateSummary();
      }

      function buildExtrasLabel(){
        if(!extrasState.length) return '';
        return extrasState.map(item => `${item.name} √ó${item.qty}`).join(', ');
      }

      function getSelectedPayment(){
        const selected = paymentRadios.find(radio => radio.checked);
        return selected ? selected.value : null;
      }

      function clearPayPalHidden(){
        if(hiddenPayPalOrder) hiddenPayPalOrder.value = '';
        if(hiddenPayPalPayer) hiddenPayPalPayer.value = '';
        if(hiddenPayPalCapture) hiddenPayPalCapture.value = '';
      }

      function setPayPalStatus(message, tone, context){
        const keys = context ? [context] : Object.keys(PAYPAL_CONTEXTS);
        keys.forEach(key => {
          const entry = PAYPAL_CONTEXTS[key];
          if(!entry || !entry.status) return;
          entry.status.textContent = message || '';
          entry.status.classList.toggle('error', tone === 'error');
          entry.status.hidden = !message;
        });
      }

      function setStripeStatus(message, tone){
        if(!stripeStatus) return;
        stripeStatus.textContent = message || '';
        stripeStatus.classList.toggle('error', tone === 'error');
        stripeStatus.hidden = !message;
      }

      function getStripeCheckoutEndpoint(){
        if(!document.body || !document.body.dataset) return '';
        return (document.body.dataset.stripeCheckoutEndpoint || '').trim();
      }

      function updateStripeCheckoutButton(){
        if(!stripeCheckoutBtn) return;
        const endpoint = getStripeCheckoutEndpoint();
        if(endpoint){
          stripeCheckoutBtn.setAttribute('aria-disabled', 'false');
          setStripeStatus('Stripe checkout is ready. We will send your cart total to Stripe when you click checkout.');
        } else {
          stripeCheckoutBtn.setAttribute('aria-disabled', 'true');
          setStripeStatus('Stripe checkout endpoint is not configured. Add data-stripe-checkout-endpoint on <body>.', 'error');
        }
      }

      async function startStripeCheckout(){
        const endpoint = getStripeCheckoutEndpoint();
        if(!endpoint){
          setStripeStatus('Stripe checkout endpoint is not configured.', 'error');
          return;
        }

        const total = Number(hiddenTotalPrice.value || 0);
        if(!(total > 0)){
          setStripeStatus('Your total is missing. Finish your package selections before checkout.', 'error');
          return;
        }

        syncFullName();
        const fd = new FormData(form);
        const payload = {
          frequency: fd.get('frequency') || '',
          total,
          currency: 'cad',
          serviceLabel: hiddenServiceLabel.value || 'Dufferin Deep Clean booking',
          customerEmail: fd.get('email') || undefined,
          metadata: {
            sqft: hiddenSqftLabel.value || String(fd.get('sqft') || ''),
            service_details: hiddenDetailSummary.value || '',
            addons: hiddenSelectedAddons.value || 'None'
          }
        };

        stripeCheckoutBtn.disabled = true;
        setStripeStatus('Creating secure Stripe checkout‚Ä¶');
        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await response.json().catch(() => ({}));
          if(!response.ok || !result.url){
            throw new Error(result.error || 'Could not create Stripe checkout session.');
          }
          if(stripeReferenceInput){
            stripeReferenceInput.value = result.id || '';
          }
          window.location.href = result.url;
        } catch(err){
          console.error('Stripe checkout start failed', err);
          setStripeStatus(err && err.message ? err.message : 'Stripe checkout failed. Please try again.', 'error');
          stripeCheckoutBtn.disabled = false;
          syncSubmitDisabled();
        }
      }

      function updateStripeReferenceStatus(){
        if(!stripeReferenceInput) return;
        if(getSelectedPayment() !== 'card') return;
        const hasReference = !!stripeReferenceInput.value.trim();
        if(hasReference){
          setStripeStatus('Stripe receipt captured. You can submit your booking.');
        } else {
          setStripeStatus('Click Stripe Checkout to pay this cart total, then return here to submit.', 'error');
        }
      }

      function toggleStripeUi(show){
        if(stripeUi){
          stripeUi.hidden = !show;
        }
        if(!show){
          setStripeStatus('', 'info');
        }
      }

      function syncSubmitDisabled(){
        if(!submitBtn) return;
        const method = getSelectedPayment();
        const stripeMissing = method === 'card' && stripeReferenceInput && !stripeReferenceInput.value.trim();
        submitBtn.disabled = (method === 'paypal' && !paypalApproved) || stripeMissing;
      }

      function togglePayPalUi(show){
        if(paypalUi){
          paypalUi.hidden = !show;
        }
        if(!show){
          setPayPalStatus('', 'info');
        }
      }

      function resetPayPalApproval(message, tone){
        paypalApproved = false;
        paypalApprovedAmount = 0;
        clearPayPalHidden();
        if(message && getSelectedPayment() === 'paypal'){
          setPayPalStatus(message, tone || 'info');
        } else if(!message){
          setPayPalStatus('', 'info');
        }
        syncSubmitDisabled();
      }

      function resolvePayPalClientId(){
        if(document.body && document.body.dataset && document.body.dataset.paypalClientId){
          return document.body.dataset.paypalClientId.trim();
        }
        if(typeof window !== 'undefined' && window.PAYPAL_CLIENT_ID){
          return String(window.PAYPAL_CLIENT_ID).trim();
        }
        return '';
      }

      function loadPayPalSdk(){
        if(window.paypal && typeof window.paypal.Buttons === 'function'){
          return Promise.resolve(window.paypal);
        }
        if(paypalScriptPromise){
          return paypalScriptPromise;
        }

        const clientId = resolvePayPalClientId();
        if(!clientId){
          const err = new Error('PayPal client ID is not configured.');
          paypalScriptPromise = Promise.reject(err);
          paypalScriptPromise.catch(() => { paypalScriptPromise = null; });
          return paypalScriptPromise;
        }

        paypalScriptPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          const params = new URLSearchParams({
            'client-id': clientId,
            currency: PAYPAL_CURRENCY,
            intent: 'capture'
          });
          script.src = `https://www.paypal.com/sdk/js?${params.toString()}`;
          script.async = true;
          script.onload = () => {
            if(window.paypal && typeof window.paypal.Buttons === 'function'){
              resolve(window.paypal);
            } else {
              reject(new Error('PayPal SDK loaded but Buttons API is unavailable.'));
            }
          };
          script.onerror = () => {
            reject(new Error('PayPal SDK failed to load.'));
          };
          document.head.appendChild(script);
        }).catch(err => {
          paypalScriptPromise = null;
          throw err;
        });

        return paypalScriptPromise;
      }

      function destroyPayPalButtons(context){
        const entry = PAYPAL_CONTEXTS[context];
        if(!entry || !entry.container) return;
        if(paypalButtonsInstances[context] && typeof paypalButtonsInstances[context].close === 'function'){
          try { paypalButtonsInstances[context].close(); } catch(_) {}
        }
        delete paypalButtonsInstances[context];
        entry.container.innerHTML = '';
      }

      function ensurePayPalButtons(context = 'main'){
        const entry = PAYPAL_CONTEXTS[context];
        if(!entry || !entry.container) return;
        if(paypalButtonsInstances[context]) return;

        setPayPalStatus('Loading PayPal‚Ä¶', 'info', context);
        loadPayPalSdk().then(paypal => {
          if(paypalButtonsInstances[context]){
            return paypalButtonsInstances[context];
          }

          entry.container.innerHTML = '';
          const buttons = paypal.Buttons({
            style: {
              layout: 'vertical',
              color: 'gold',
              label: 'pay',
              shape: 'rect'
            },
            onClick(data, actions){
              const totalDue = Number(hiddenTotalPrice.value || 0);
              if(!(totalDue > 0)){
                setPayPalStatus('Finish selecting your services so we can calculate the total before paying with PayPal.', 'error');
                return actions.reject();
              }
              paypalApproved = false;
              paypalApprovedAmount = 0;
              clearPayPalHidden();
              syncSubmitDisabled();
              setPayPalStatus('Redirecting to PayPal‚Ä¶');
              return actions.resolve();
            },
            createOrder(data, actions){
              const totalDue = Number(hiddenTotalPrice.value || 0);
              if(!(totalDue > 0)){
                setPayPalStatus('Your total is missing. Adjust your booking details before checking out with PayPal.', 'error');
                return actions.reject();
              }
              const amount = (Math.round(totalDue * 100) / 100).toFixed(2);
              return actions.order.create({
                purchase_units: [{
                  amount: {
                    currency_code: PAYPAL_CURRENCY,
                    value: amount
                  },
                  description: 'Dufferin Deep Clean booking total'
                }],
                application_context: {
                  shipping_preference: 'NO_SHIPPING'
                }
              });
            },
            onApprove(data, actions){
              setPayPalStatus('Processing your PayPal payment‚Ä¶');
              return actions.order.capture().then(details => {
                paypalApproved = true;
                paypalApprovedAmount = Math.round(Number(hiddenTotalPrice.value || 0) * 100) / 100;
                if(hiddenPayPalOrder) hiddenPayPalOrder.value = data.orderID || details.id || '';
                if(hiddenPayPalPayer) hiddenPayPalPayer.value = details?.payer?.payer_id || '';
                const capture = details?.purchase_units?.[0]?.payments?.captures?.[0];
                if(hiddenPayPalCapture) hiddenPayPalCapture.value = capture?.id || '';
                const payerName = details?.payer?.name?.given_name || 'PayPal customer';
                setPayPalStatus(`Payment received from ${payerName}. You can now submit your booking.`);
                syncSubmitDisabled();
                buildReview();
                dispatchNavCartUpdate(false);
              }).catch(err => {
                console.error('PayPal capture error', err);
                resetPayPalApproval();
                setPayPalStatus('PayPal could not capture the payment. Please try again.', 'error');
                throw err;
              });
            },
            onCancel(){
              resetPayPalApproval('PayPal checkout was cancelled. You can try again or contact us for assistance.', 'error');
            },
            onError(err){
              console.error('PayPal error', err);
              resetPayPalApproval('PayPal reported an error. Please try again or contact us for assistance.', 'error');
            }
          });

          paypalButtonsInstances[context] = buttons;
          return buttons.render(entry.container).catch(err => {
            console.error('PayPal render error', err);
            destroyPayPalButtons(context);
            resetPayPalApproval('PayPal could not initialize. Refresh the page or contact us for assistance.', 'error');
            throw err;
          });
        }).catch(err => {
          console.error('PayPal load error', err);
          destroyPayPalButtons(context);
          const message = 'PayPal checkout is currently unavailable. Please contact us to complete your payment.';
          setPayPalStatus(message, 'error', context);
        });
      }

      document.addEventListener('nav-cart:opened', () => {
        ensurePayPalButtons('nav');
      });

      function applyPaymentSelection(){
        const method = getSelectedPayment();
        if(method === 'paypal'){
          togglePayPalUi(true);
          toggleStripeUi(false);
          ensurePayPalButtons('main');
          ensurePayPalButtons('nav');
          if(paypalApproved){
            setPayPalStatus('PayPal payment approved. You can submit your booking.');
          } else {
            setPayPalStatus('Complete your PayPal payment to enable submission.');
          }
        } else if(method === 'card'){
          togglePayPalUi(false);
          resetPayPalApproval('');
          setPayPalStatus('', 'info');
          toggleStripeUi(true);
          updateStripeCheckoutButton();
          updateStripeReferenceStatus();
        } else {
          togglePayPalUi(false);
          resetPayPalApproval('');
          setPayPalStatus('', 'info');
          toggleStripeUi(false);
        }
        syncSubmitDisabled();
      }

      function selectedFrequency(){
        return frequencyInputs.find(input => input.checked) || null;
      }

      function refreshCartButton(){
        if(addToCartBtn){
          const label = addToCartBtn.querySelector('.cart-btn-text');
          const labelText = cartAdded ? 'Added to Cart' : 'Add to Cart';
          if(label){
            label.textContent = labelText;
          } else {
            addToCartBtn.textContent = labelText;
          }
          addToCartBtn.classList.toggle('is-added', cartAdded);
          addToCartBtn.setAttribute('aria-disabled', addToCartBtn.disabled ? 'true' : 'false');
        }
        if(hiddenCartStatus){
          hiddenCartStatus.value = cartAdded ? 'added' : 'pending';
        }
        if(cartSummaryEl){
          cartSummaryEl.classList.toggle('is-added', cartAdded);
        }
      }

      function applyCartVisibility(stepIndex){
        if(!formColumnsEl) return;
        const hide = false;
        if(cartSummaryEl){
          cartSummaryEl.hidden = hide;
          cartSummaryEl.setAttribute('aria-hidden', hide ? 'true' : 'false');
        }
        if(summaryColumnEl){
          summaryColumnEl.hidden = hide;
          summaryColumnEl.setAttribute('aria-hidden', hide ? 'true' : 'false');
        }
        formColumnsEl.classList.toggle('cart-summary-hidden', hide);
      }

      function updateSummary(){
        applyCartVisibility(current);
        if(!quoteAvailable){
          cartAdded = false;
          if(cartStatus){
            cartStatus.classList.remove('error');
            cartStatus.textContent = 'Select a package on the quote page to see pricing here.';
          }
          if(recapBase) recapBase.textContent = '‚Äî';
          if(recapDetailRow){
            recapDetailRow.hidden = true;
          }
          if(recapExtrasRow){
            recapExtrasRow.hidden = true;
          }
          if(recapDiscountRow){
            recapDiscountRow.hidden = true;
          }
          if(recapTotal){
            recapTotal.textContent = '‚Äî';
          }
          if(addToCartBtn){
            addToCartBtn.disabled = true;
            addToCartBtn.setAttribute('aria-disabled', 'true');
          }
          syncCartSchedule();
          refreshCartButton();
          latestCartState = null;
          dispatchNavCartUpdate(false);
          return;
        }
        const extras = computeExtras();
        const extrasTotal = extras.reduce((sum, item) => sum + item.price * item.qty, 0);
        renderCartDescription(extras);
        const freqInput = selectedFrequency();
        const discountRate = freqInput ? Number(freqInput.dataset.discount || 0) : 0;
        const subtotal = totalBase + extrasTotal;
        const discount = subtotal * discountRate;
        const finalTotal = subtotal - discount;

        const baseLabel = hiddenServiceLabel.value || resolvedServiceLabel || serviceKey || DEFAULT_SERVICE_LABEL;
        const freqLabel = freqInput ? (FREQUENCY_LABELS[freqInput.value] || freqInput.value) : '';

        if(cartService){
          cartService.textContent = freqLabel ? `${baseLabel} ‚Ä¢ ${freqLabel}` : baseLabel;
        }

        if(recapBase){ recapBase.textContent = basePrice > 0 ? `$${Math.round(basePrice)}` : '‚Äî'; }
        if(recapDetailRow && recapDetail){
          if(detailPrice > 0){
            recapDetailRow.hidden = false;
            recapDetail.textContent = `+$${Math.round(detailPrice)}`;
          } else {
            recapDetailRow.hidden = true;
            recapDetail.textContent = '‚Äî';
          }
        }
        if(recapExtrasRow && recapExtras){
          if(extrasTotal > 0){
            recapExtrasRow.hidden = false;
            recapExtras.textContent = `+$${Math.round(extrasTotal)}`;
          } else {
            recapExtrasRow.hidden = true;
            recapExtras.textContent = '‚Äî';
          }
        }
        if(recapDiscountRow && recapDiscount){
          if(discount > 0){
            recapDiscountRow.hidden = false;
            recapDiscount.textContent = `-$${Math.round(discount)}`;
          } else {
            recapDiscountRow.hidden = true;
            recapDiscount.textContent = '‚Äî';
          }
        }
        if(recapTotal){
          recapTotal.textContent = finalTotal > 0 ? `$${Math.round(finalTotal)}` : '‚Äî';
        }

        if(hiddenAddonsPrice) hiddenAddonsPrice.value = extrasTotal.toFixed(2);
        if(hiddenDiscountPrice) hiddenDiscountPrice.value = discount.toFixed(2);
        if(hiddenTotalPrice) hiddenTotalPrice.value = finalTotal.toFixed(2);
        const extrasLabel = buildExtrasLabel();
        if(hiddenSelectedAddons) hiddenSelectedAddons.value = extrasLabel;

        const signature = [basePrice, detailPrice, extrasTotal, discount, finalTotal].map(value => Math.round(value * 100) / 100).join('|');
        if(signature !== lastCartSignature){
          const wasAdded = cartAdded;
          lastCartSignature = signature;
          if(wasAdded){
            cartAdded = false;
            refreshCartButton();
            if(cartStatus){
              cartStatus.classList.remove('error');
              cartStatus.textContent = "Totals updated. Add to cart again when you're ready.";
            }
          } else if(cartStatus && cartStatus.textContent && cartStatus.textContent.includes('Totals updated')){
            cartStatus.textContent = '';
          }
        }

        const normalizedTotal = Math.round(finalTotal * 100) / 100;
        if(paypalApproved && Math.abs(normalizedTotal - paypalApprovedAmount) > 0.01){
          paypalApproved = false;
          paypalApprovedAmount = 0;
          clearPayPalHidden();
          if(getSelectedPayment() === 'paypal'){
            setPayPalStatus('Your total changed. Please approve the PayPal payment again.');
          }
        }

        updateStripeCheckoutButton();
        updateStripeReferenceStatus();

        if(addToCartBtn){
          const hasFrequency = !!freqInput;
          const canAdd = quoteAvailable && current >= 0 && hasFrequency;
          addToCartBtn.disabled = cartAdded ? true : !canAdd;
          addToCartBtn.setAttribute('aria-disabled', addToCartBtn.disabled ? 'true' : 'false');
          if(!quoteAvailable){
            if(cartStatus && cartStatus.textContent === ''){
              cartStatus.textContent = 'Select a package on the quote page to see pricing here.';
            }
          } else if(!canAdd){
            if(!cartAdded && cartStatus){
              if(current >= 0){
                cartStatus.classList.remove('error');
                cartStatus.textContent = 'Select a visit frequency to add this package to your cart.';
              } else if(cartStatus.textContent === 'Select a visit frequency to add this package to your cart.'){
                cartStatus.textContent = '';
              }
            }
          } else if(!cartAdded && cartStatus && cartStatus.textContent === 'Select a visit frequency to add this package to your cart.'){
            cartStatus.textContent = '';
          }
        }

        syncCartSchedule();
        refreshCartButton();
        syncSubmitDisabled();

        latestCartState = {
          cartAdded,
          quantity: 1,
          serviceLabel: baseLabel,
          frequencyLabel: freqLabel,
          basePrice,
          detailPrice,
          extrasTotal,
          extrasLabel,
          discount,
          total: finalTotal,
          checkoutUrl: 'book.html#cartSummary',
          status: cartStatus && cartStatus.textContent ? cartStatus.textContent : ''
        };
        dispatchNavCartUpdate(false);
      }

      addonPills.forEach(pill => {
        pill.addEventListener('click', (event) => {
          const parent = pill.closest('.addon-group');
          if(!parent || !parent.classList.contains('active')) return;

          autoAddAfterSkip = false;
          pill.classList.toggle('active');
          const active = pill.classList.contains('active');
          pill.setAttribute('aria-pressed', active ? 'true' : 'false');
          updateSummary();
        });

        pill.addEventListener('keydown', evt => {
          if(evt.key === 'Enter' || evt.key === ' '){
            evt.preventDefault();
            pill.click();
          }
        });

        pill.setAttribute('tabindex', '0');
        pill.setAttribute('role', 'button');
        pill.setAttribute('aria-pressed', 'false');

      });

      frequencyInputs.forEach(input => {
        input.addEventListener('change', () => {
          if(cartStatus){
            cartStatus.classList.remove('error');
            if(cartStatus.textContent === 'Select a visit frequency to add this package to your cart.' ||
               cartStatus.textContent === 'Please choose how often we should visit before moving on.'){
              cartStatus.textContent = '';
            }
          }
          updateSummary();
          updateScheduleDisplays();
          renderCalendar();
          if(autoAddAfterSkip){
            ensureCartAdded({ animate: true });
          }
        });
      });

      paymentRadios.forEach(radio => {
        radio.addEventListener('change', applyPaymentSelection);
      });

      if(stripeCheckoutBtn){
        stripeCheckoutBtn.addEventListener('click', (event) => {
          event.preventDefault();
          if(stripeCheckoutBtn.getAttribute('aria-disabled') === 'true') return;
          startStripeCheckout();
        });
      }
      if(stripeReferenceInput){
        stripeReferenceInput.addEventListener('input', () => {
          updateStripeReferenceStatus();
          syncSubmitDisabled();
          buildReview();
        });
      }

      if(addToCartBtn){
        addToCartBtn.addEventListener('click', () => {
          if(addToCartBtn.disabled) return;
          cartAdded = true;
          refreshCartButton();
          if(cartStatus){
            cartStatus.classList.remove('error');
            cartStatus.textContent = 'Package added to your cart. Continue through the steps to finalize.';
          }
          triggerCartFlight();
          updateSummary();
          dispatchNavCartUpdate(true);
        });
      }

      function showStep(i){
        steps.forEach((step, idx) => { step.hidden = idx !== i; });
        stepper.forEach((item, idx) => {
          const isActive = idx === i;
          const isDone = idx < i;
          const isClickable = idx <= i;
          item.classList.toggle('active', isActive);
          item.classList.toggle('done', isDone);
          item.classList.toggle('clickable', isClickable);
          item.tabIndex = isClickable ? 0 : -1;
          item.setAttribute('aria-current', isActive ? 'step' : 'false');
          item.setAttribute('aria-disabled', isClickable ? 'false' : 'true');
        });
        current = i;
        applyCartVisibility(i);
        updateSummary();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        if(i === steps.length - 1){
          buildReview();
          applyPaymentSelection();
        }
      }

      document.addEventListener('click', (event) => {
        if(event.target.matches('.skip')){
          clearExtras();
          autoAddAfterSkip = true;
          const nextIndex = Math.min(current + 1, steps.length - 1);
          showStep(nextIndex);
          if(frequencyInputs.length){
            frequencyInputs[0].focus();
          }
          return;
        }
        if(event.target.matches('.next')){
          if(current === 0){
            if(!quoteAvailable){
              if(cartStatus){
                cartStatus.classList.add('error');
                cartStatus.textContent = 'Select a package on the quote page to see pricing here.';
              }
              return;
            }
            const freqCheck = selectedFrequency();
            if(!freqCheck){
              if(cartStatus){
                cartStatus.classList.add('error');
                cartStatus.textContent = 'Please choose how often we should visit before moving on.';
              }
              if(frequencyInputs.length){
                frequencyInputs[0].focus();
              }
              return;
            }
            if(!selectedVisitDate){
              if(calendarError){
                calendarError.hidden = false;
              }
              if(calendarSection){
                calendarSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
              return;
            }
          }
          const visible = steps[current];
          const required = Array.from(visible.querySelectorAll('[required]'));
          for(const field of required){
            if(!field.value){
              field.focus();
              if(field.reportValidity){ field.reportValidity(); }
              return;
            }
          }
          const prevIndex = current;
          const nextIndex = Math.min(current + 1, steps.length - 1);
          showStep(nextIndex);
        }
        if(event.target.matches('.back')){
          showStep(Math.max(current - 1, 0));
        }
      });

      function buildReview(){
        if(!reviewList) return;
        syncFullName();
        const fd = new FormData(form);
        const fullName = (() => {
          const fields = [fd.get('first_name'), fd.get('last_name')].filter(Boolean).map(v => v.trim());
          if(hiddenFullName && hiddenFullName.value) return hiddenFullName.value;
          if(fields.length) return fields.join(' ');
          return '';
        })();
        if(hiddenFullName && !hiddenFullName.value){
          hiddenFullName.value = fullName;
        }

        const rows = [
          ['Service', hiddenServiceLabel.value || '‚Äî'],
          ['Square Footage', hiddenSqftLabel.value || fd.get('sqft') || '‚Äî'],
          ['Details', hiddenDetailSummary.value || '‚Äî'],
          ['Frequency', FREQUENCY_LABELS[fd.get('frequency')] || '‚Äî'],
          ['Add-ons', hiddenSelectedAddons.value || 'None'],
          ['Base Package', hiddenBasePrice.value ? `$${Math.round(Number(hiddenBasePrice.value))}` : '‚Äî'],
          ['Service Details', hiddenDetailPrice.value ? `$${Math.round(Number(hiddenDetailPrice.value))}` : '‚Äî'],
          ['Add-on Total', hiddenAddonsPrice.value ? `$${Math.round(Number(hiddenAddonsPrice.value))}` : '‚Äî'],
          ['Frequency Savings', hiddenDiscountPrice.value && Number(hiddenDiscountPrice.value) ? `-$${Math.round(Number(hiddenDiscountPrice.value))}` : '‚Äî'],
          ['Total Due Today', hiddenTotalPrice.value && Number(hiddenTotalPrice.value) ? `$${Math.round(Number(hiddenTotalPrice.value))}` : '‚Äî'],
          ['PayPal Reference', hiddenPayPalCapture.value || hiddenPayPalOrder.value || '‚Äî'],
          ['Stripe Reference', fd.get('stripe_reference') || '‚Äî'],
          ['First Visit', formatDateHumanFromInput(fd.get('first_visit_date'))],
          ['Next Visit', formatDateHumanFromInput(fd.get('follow_up_visit_date'))],
          ['Full Name', fullName || '‚Äî'],
          ['Email', fd.get('email') || '‚Äî'],
          ['Phone', fd.get('phone') || '‚Äî'],
          ['Notes', fd.get('notes') || '‚Äî'],
          ['Cart Status', hiddenCartStatus && hiddenCartStatus.value === 'added' ? 'Added to cart' : 'Not added yet']
        ];

        reviewList.innerHTML = rows.map(([label, value]) => `<dt>${label}</dt><dd>${String(value)}</dd>`).join('');
      }

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const method = getSelectedPayment();
        if(method === 'paypal' && !paypalApproved){
          setPayPalStatus('Please complete your PayPal payment before submitting your booking.', 'error');
          return;
        }
        if(method === 'card' && stripeReferenceInput && !stripeReferenceInput.value.trim()){
          setStripeStatus('Please add your Stripe receipt or session ID before submitting.', 'error');
          stripeReferenceInput.focus();
          return;
        }

        if(hiddenCartStatus && hiddenCartStatus.value !== 'added'){
          if(cartStatus){
            cartStatus.classList.add('error');
            cartStatus.textContent = 'Please add the package to your cart before confirming.';
          }
          if(addToCartBtn) addToCartBtn.focus();
          return;
        }

        const allButtons = form.querySelectorAll('button');
        allButtons.forEach(btn => btn.disabled = true);
        if(submitBtn) submitBtn.textContent = 'Sending‚Ä¶';

        syncFullName();
        const fd = new FormData(form);
        if(!fd.get('_subject')){
          fd.append('_subject', 'New Booking Request ‚Äî Dufferin Deep Clean');
        }

        const fullName = hiddenFullName ? hiddenFullName.value : [fd.get('first_name'), fd.get('last_name')].filter(Boolean).join(' ');
        if(fullName){ fd.set('name', fullName); }
        const freqMapShort = {
          weekly: 'Weekly (25%)',
          biweekly: 'Bi-Weekly (20%)',
          triweekly: 'Tri-Weekly (15%)',
          monthly: 'Monthly (10%)',
          biannual: 'Biannual (5%)',
          onetime: 'One-time'
        };
        const summaryLines = [
          `Service: ${hiddenServiceLabel.value || serviceKey || '‚Äî'}`,
          `Square Footage: ${hiddenSqftLabel.value || fd.get('sqft') || '‚Äî'}`,
          `Details: ${hiddenDetailSummary.value || '‚Äî'}`,
          `Frequency: ${freqMapShort[fd.get('frequency')] || '‚Äî'}`,
          `Cart Status: ${hiddenCartStatus && hiddenCartStatus.value === 'added' ? 'Added to cart' : 'Not added yet'}`,
          `Base Package: ${hiddenBasePrice.value ? `$${Math.round(Number(hiddenBasePrice.value))}` : '‚Äî'}`,
          `Service Details: ${hiddenDetailPrice.value ? `$${Math.round(Number(hiddenDetailPrice.value))}` : '‚Äî'}`,
          `Add-ons: ${hiddenSelectedAddons.value || 'None'}`,
          `Add-on Total: ${hiddenAddonsPrice.value ? `$${Math.round(Number(hiddenAddonsPrice.value))}` : '‚Äî'}`,
          `Frequency Savings: ${hiddenDiscountPrice.value && Number(hiddenDiscountPrice.value) ? `-$${Math.round(Number(hiddenDiscountPrice.value))}` : '‚Äî'}`,
          `Total Due Today: ${hiddenTotalPrice.value && Number(hiddenTotalPrice.value) ? `$${Math.round(Number(hiddenTotalPrice.value))}` : '‚Äî'}`,
          `First Visit: ${formatDateHumanFromInput(fd.get('first_visit_date'))}`,
          `Next Visit: ${formatDateHumanFromInput(fd.get('follow_up_visit_date'))}`,
          `Full Name: ${fullName || '‚Äî'}`,
          `Email: ${fd.get('email') || '‚Äî'}`,
          `Phone: ${fd.get('phone') || '‚Äî'}`
        ];

        if(hiddenPayPalCapture.value || hiddenPayPalOrder.value){
          summaryLines.push(`PayPal Reference: ${hiddenPayPalCapture.value || hiddenPayPalOrder.value}`);
        }
        if(fd.get('stripe_reference')){
          summaryLines.push(`Stripe Reference: ${fd.get('stripe_reference')}`);
        }

        const pricingSummary = summaryLines.join('\n');

        fd.append('pricing_summary', pricingSummary);

        try {
          const res = await fetch(form.action, {
            method: 'POST',
            body: fd,
            headers: { Accept: 'application/json' }
          });

          if(res.ok){
            form.hidden = true;
            if(layoutEl) layoutEl.hidden = true;
            if(successEl) successEl.hidden = false;
          } else {
            let message = 'There was a problem sending your booking request. Please try again.';
            try {
              const data = await res.json();
              if(data && data.errors && data.errors.length){
                message = data.errors.map(err => err.message).join('\n');
              }
            } catch(_){}
            alert(message);
          }
        } catch(err){
          alert('Network error. Please check your connection and try again.');
        } finally {
          allButtons.forEach(btn => btn.disabled = false);
          if(submitBtn) submitBtn.textContent = 'Submit';
        }
      });

      updateSummary();
      applyPaymentSelection();
      showStep(0);
    })();
  </script>
</body>
</html>
